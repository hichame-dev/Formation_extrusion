<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Formation Poste Extrusion - GEMEF Industries</title>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Barlow:wght@400;500;600;700;800&family=Barlow+Condensed:wght@600;700&display=swap');
        :root {
            --gemef-orange: #E87722;
            --gemef-orange-dark: #C5611A;
            --gemef-gray: #4A4A4A;
            --status-pending: #E74C3C;
            --status-progress: #F39C12;
            --status-acquired: #27AE60;
            --bg-main: #F5F5F5;
            --bg-card: #FFFFFF;
            --border-color: #E0E0E0;
            --text-primary: #2C2C2C;
            --text-secondary: #666666;
        }
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: 'Barlow', Arial, Helvetica, sans-serif; background: var(--bg-main); color: var(--text-primary); line-height: 1.5; }
        .header { background: linear-gradient(135deg, var(--gemef-gray) 0%, #2C2C2C 100%); color: white; padding: 20px 30px; display: flex; align-items: center; justify-content: space-between; box-shadow: 0 4px 20px rgba(0,0,0,0.15); position: sticky; top: 0; z-index: 100; }
        .logo-section { display: flex; align-items: center; gap: 20px; }
        .logo { width: 70px; height: 70px; background: var(--gemef-orange); border-radius: 8px; display: flex; align-items: center; justify-content: center; font-family: 'Barlow Condensed', Arial, sans-serif; font-weight: 700; font-size: 28px; color: white; overflow: hidden; cursor: pointer; position: relative; }
        .logo img { width: 100%; height: 100%; object-fit: contain; }
        .logo-upload { position: absolute; top: 0; left: 0; width: 100%; height: 100%; opacity: 0; cursor: pointer; }
        .header-title h1 { font-family: 'Barlow Condensed', Arial, sans-serif; font-size: 28px; font-weight: 700; text-transform: uppercase; }
        .header-title p { font-size: 14px; opacity: 0.8; }
        .header-actions { display: flex; gap: 12px; flex-wrap: wrap; }
        .btn { padding: 12px 24px; border: none; border-radius: 6px; font-family: 'Barlow', Arial, sans-serif; font-weight: 600; font-size: 14px; cursor: pointer; transition: all 0.2s ease; display: flex; align-items: center; gap: 8px; }
        .btn-primary { background: var(--gemef-orange); color: white; }
        .btn-primary:hover { background: var(--gemef-orange-dark); transform: translateY(-2px); }
        .btn-secondary { background: rgba(255,255,255,0.1); color: white; border: 1px solid rgba(255,255,255,0.3); }
        .btn-secondary:hover { background: rgba(255,255,255,0.2); }
        .btn-success { background: var(--status-acquired); color: white; }
        .btn-success:hover { background: #219a52; }
        .container { max-width: 1200px; margin: 0 auto; padding: 30px; }
        .progress-overview { background: var(--bg-card); border-radius: 12px; padding: 25px 30px; margin-bottom: 30px; box-shadow: 0 2px 12px rgba(0,0,0,0.06); border: 1px solid var(--border-color); }
        .progress-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; }
        .progress-title { font-family: 'Barlow Condensed', Arial, sans-serif; font-size: 20px; font-weight: 600; color: var(--gemef-gray); text-transform: uppercase; }
        .progress-percentage { font-size: 36px; font-weight: 800; color: var(--gemef-orange); }
        .progress-bar-container { background: #E8E8E8; height: 12px; border-radius: 6px; overflow: hidden; margin-bottom: 20px; }
        .progress-bar { height: 100%; background: linear-gradient(90deg, var(--gemef-orange) 0%, var(--status-acquired) 100%); border-radius: 6px; transition: width 0.5s ease; }
        .progress-stats { display: flex; gap: 30px; flex-wrap: wrap; }
        .stat { display: flex; align-items: center; gap: 10px; }
        .stat-dot { width: 14px; height: 14px; border-radius: 50%; }
        .stat-dot.pending { background: var(--status-pending); }
        .stat-dot.progress { background: var(--status-progress); }
        .stat-dot.acquired { background: var(--status-acquired); }
        .stat-count { font-weight: 700; }
        .stat-label { color: var(--text-secondary); }

        /* Barre de profils */
        .profile-bar { background: linear-gradient(135deg, var(--gemef-orange) 0%, var(--gemef-orange-dark) 100%); border-radius: 12px; padding: 15px 25px; margin-bottom: 20px; box-shadow: 0 2px 12px rgba(0,0,0,0.1); display: flex; align-items: center; gap: 15px; flex-wrap: wrap; }
        .profile-bar label { color: white; font-weight: 600; }
        .profile-select { padding: 10px 15px; border: none; border-radius: 6px; font-family: 'Barlow', Arial, sans-serif; font-size: 14px; font-weight: 600; min-width: 200px; cursor: pointer; }
        .profile-select:focus { outline: 2px solid white; }
        .profile-btn { padding: 10px 16px; border: 2px solid white; border-radius: 6px; background: transparent; color: white; font-family: 'Barlow', Arial, sans-serif; font-weight: 600; font-size: 13px; cursor: pointer; transition: all 0.2s ease; }
        .profile-btn:hover { background: white; color: var(--gemef-orange); }
        .profile-btn.danger { border-color: #ffcccc; color: #ffcccc; }
        .profile-btn.danger:hover { background: #ffcccc; color: var(--status-pending); }

        /* Filtres */
        .filters-bar { background: var(--bg-card); border-radius: 12px; padding: 15px 25px; margin-bottom: 20px; box-shadow: 0 2px 12px rgba(0,0,0,0.06); border: 1px solid var(--border-color); display: flex; align-items: center; gap: 15px; flex-wrap: wrap; }
        .filters-label { font-weight: 600; color: var(--gemef-gray); }
        .filter-btn { padding: 8px 16px; border: 2px solid var(--border-color); border-radius: 20px; background: white; font-family: 'Barlow', Arial, sans-serif; font-weight: 600; font-size: 13px; cursor: pointer; transition: all 0.2s ease; }
        .filter-btn:hover { border-color: var(--gemef-orange); }
        .filter-btn.active { background: var(--gemef-orange); color: white; border-color: var(--gemef-orange); }
        .filter-btn.filter-pending.active { background: var(--status-pending); border-color: var(--status-pending); }
        .filter-btn.filter-progress.active { background: var(--status-progress); border-color: var(--status-progress); }
        .filter-btn.filter-acquired.active { background: var(--status-acquired); border-color: var(--status-acquired); }

        .info-grid { display: grid; grid-template-columns: repeat(2, 1fr); gap: 20px; margin-bottom: 30px; }
        .info-card { background: var(--bg-card); border-radius: 12px; padding: 25px; box-shadow: 0 2px 12px rgba(0,0,0,0.06); border: 1px solid var(--border-color); }
        .info-card h3 { font-family: 'Barlow Condensed', Arial, sans-serif; font-size: 16px; font-weight: 600; color: var(--gemef-orange); text-transform: uppercase; margin-bottom: 15px; padding-bottom: 10px; border-bottom: 2px solid var(--gemef-orange); }
        .info-row { display: flex; margin-bottom: 12px; }
        .info-label { width: 140px; font-weight: 500; color: var(--text-secondary); font-size: 14px; }
        .info-value { flex: 1; }
        .info-value input { width: 100%; padding: 8px 12px; border: 1px solid var(--border-color); border-radius: 6px; font-family: 'Barlow', Arial, sans-serif; font-size: 14px; }
        .info-value input:focus { outline: none; border-color: var(--gemef-orange); }

        /* Carte Salarie en formation - Style special */
        .info-card.salarie-card { background: linear-gradient(135deg, #FFF8F3 0%, #FFEFE5 100%); border: 2px solid var(--gemef-orange); box-shadow: 0 4px 20px rgba(232, 119, 34, 0.15); }
        .info-card.salarie-card h3 { font-size: 18px; background: var(--gemef-orange); color: white; margin: -25px -25px 20px -25px; padding: 15px 25px; border-radius: 10px 10px 0 0; border-bottom: none; }
        .info-card.salarie-card .info-row { margin-bottom: 18px; align-items: center; }
        .info-card.salarie-card .info-label { font-weight: 600; color: var(--gemef-gray); font-size: 15px; }
        .info-card.salarie-card .info-value input { padding: 12px 16px; font-size: 16px; font-weight: 600; border: 2px solid #E0D0C5; border-radius: 8px; background: white; }
        .info-card.salarie-card .info-value input:focus { border-color: var(--gemef-orange); box-shadow: 0 0 0 3px rgba(232, 119, 34, 0.2); }
        .section { background: var(--bg-card); border-radius: 12px; margin-bottom: 20px; box-shadow: 0 2px 12px rgba(0,0,0,0.06); border: 1px solid var(--border-color); overflow: hidden; }
        .section.hidden { display: none; }
        .section-header { background: linear-gradient(135deg, var(--gemef-gray) 0%, #3D3D3D 100%); color: white; padding: 18px 25px; display: flex; justify-content: space-between; align-items: center; cursor: pointer; }
        .section-header:hover { background: linear-gradient(135deg, #3D3D3D 0%, var(--gemef-gray) 100%); }
        .section-title { font-family: 'Barlow Condensed', Arial, sans-serif; font-size: 18px; font-weight: 600; text-transform: uppercase; display: flex; align-items: center; gap: 12px; }
        .section-number { background: var(--gemef-orange); width: 32px; height: 32px; border-radius: 6px; display: flex; align-items: center; justify-content: center; font-weight: 700; }
        .section-progress { display: flex; align-items: center; gap: 15px; }
        .section-progress-bar { width: 120px; height: 8px; background: rgba(255,255,255,0.2); border-radius: 4px; overflow: hidden; }
        .section-progress-fill { height: 100%; background: var(--gemef-orange); border-radius: 4px; transition: width 0.3s ease; }
        .section-progress-text { font-size: 14px; font-weight: 600; min-width: 45px; }
        .toggle-icon { font-size: 20px; transition: transform 0.3s ease; }
        .section.collapsed .toggle-icon { transform: rotate(-90deg); }
        .section.collapsed .section-content { display: none; }
        .task { display: flex; align-items: flex-start; padding: 16px 25px; border-bottom: 1px solid var(--border-color); flex-direction: column; gap: 8px; }
        .task.hidden { display: none; }
        .task:last-child { border-bottom: none; }
        .task:hover { background: #FAFAFA; }
        .task-main { display: flex; align-items: center; width: 100%; }
        .task-text { flex: 1; font-size: 14px; padding-right: 20px; }
        .task-status { display: flex; gap: 8px; }
        .task-history { font-size: 11px; color: var(--text-secondary); padding-left: 5px; font-style: italic; }
        .status-btn { padding: 8px 16px; border: 2px solid transparent; border-radius: 6px; font-family: 'Barlow', Arial, sans-serif; font-weight: 600; font-size: 12px; cursor: pointer; transition: all 0.2s ease; text-transform: uppercase; }
        .status-btn.pending { background: #FDEAEA; color: var(--status-pending); }
        .status-btn.pending.active { background: var(--status-pending); color: white; }
        .status-btn.progress { background: #FEF5E7; color: var(--status-progress); }
        .status-btn.progress.active { background: var(--status-progress); color: white; }
        .status-btn.acquired { background: #E8F6EF; color: var(--status-acquired); }
        .status-btn.acquired.active { background: var(--status-acquired); color: white; }
        .status-btn:hover { transform: scale(1.05); }
        .comments-section { background: var(--bg-card); border-radius: 12px; padding: 25px; margin-bottom: 30px; box-shadow: 0 2px 12px rgba(0,0,0,0.06); border: 1px solid var(--border-color); }
        .comments-section h3 { font-family: 'Barlow Condensed', Arial, sans-serif; font-size: 18px; font-weight: 600; color: var(--gemef-gray); text-transform: uppercase; margin-bottom: 15px; }
        .comments-section textarea { width: 100%; min-height: 120px; padding: 15px; border: 1px solid var(--border-color); border-radius: 8px; font-family: 'Barlow', Arial, sans-serif; font-size: 14px; resize: vertical; }
        .comments-section textarea:focus { outline: none; border-color: var(--gemef-orange); }
        .signatures-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 20px; margin-bottom: 30px; }
        .signature-card { background: var(--bg-card); border-radius: 12px; padding: 25px; box-shadow: 0 2px 12px rgba(0,0,0,0.06); border: 1px solid var(--border-color); text-align: center; }
        .signature-card h4 { font-family: 'Barlow Condensed', Arial, sans-serif; font-size: 16px; font-weight: 600; color: var(--gemef-orange); text-transform: uppercase; margin-bottom: 15px; }
        .signature-field { margin-bottom: 12px; }
        .signature-field label { display: block; font-size: 12px; color: var(--text-secondary); margin-bottom: 5px; }
        .signature-field input { width: 100%; padding: 10px; border: 1px solid var(--border-color); border-radius: 6px; font-family: 'Barlow', Arial, sans-serif; font-size: 14px; text-align: center; }
        .signature-field input:focus { outline: none; border-color: var(--gemef-orange); }

        /* Signature Canvas */
        .signature-canvas-container { position: relative; margin-top: 10px; }
        .signature-canvas { border: 2px dashed var(--border-color); border-radius: 8px; background: #FAFAFA; cursor: crosshair; touch-action: none; width: 100%; height: 100px; }
        .signature-canvas:hover { border-color: var(--gemef-orange); }
        .clear-signature { position: absolute; top: 5px; right: 5px; background: var(--status-pending); color: white; border: none; border-radius: 4px; padding: 4px 8px; font-size: 11px; cursor: pointer; }
        .clear-signature:hover { background: #c0392b; }

        .footer { text-align: center; padding: 20px; color: var(--text-secondary); font-size: 13px; }
        .notification { position: fixed; bottom: 30px; right: 30px; background: var(--status-acquired); color: white; padding: 15px 25px; border-radius: 8px; font-weight: 600; box-shadow: 0 4px 20px rgba(0,0,0,0.2); transform: translateY(100px); opacity: 0; transition: all 0.3s ease; z-index: 1000; }
        .notification.show { transform: translateY(0); opacity: 1; }

        /* Modal */
        .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); display: none; justify-content: center; align-items: center; z-index: 2000; }
        .modal-overlay.show { display: flex; }
        .modal { background: white; border-radius: 12px; padding: 30px; max-width: 500px; width: 90%; max-height: 80vh; overflow-y: auto; }
        .modal h3 { font-family: 'Barlow Condensed', Arial, sans-serif; font-size: 20px; margin-bottom: 20px; color: var(--gemef-gray); }
        .modal-actions { display: flex; gap: 10px; margin-top: 20px; }
        .modal-actions .btn { flex: 1; justify-content: center; }

        /* Hidden file input */
        .hidden-input { display: none; }

        @media print {
            .header { position: static; background: white !important; color: black !important; box-shadow: none; border-bottom: 3px solid var(--gemef-orange); }
            .header-actions { display: none; }
            .profile-bar { display: none; }
            .filters-bar { display: none; }
            .section.collapsed .section-content { display: block !important; }
            .section.hidden { display: block !important; }
            .task.hidden { display: flex !important; }
            .status-btn.active { border: 2px solid currentColor !important; }
            .signature-canvas { border-style: solid; }
            .clear-signature { display: none; }
        }
        @media (max-width: 768px) {
            .header { flex-direction: column; gap: 15px; text-align: center; }
            .header-actions { justify-content: center; }
            .info-grid, .signatures-grid { grid-template-columns: 1fr; }
            .task-main { flex-direction: column; align-items: flex-start; gap: 12px; }
            .task-status { width: 100%; justify-content: space-between; }
            .status-btn { flex: 1; padding: 10px 8px; font-size: 11px; }
            .filters-bar { justify-content: center; }
        }
    </style>
</head>
<body>
    <header class="header">
        <div class="logo-section">
            <div class="logo" id="logoContainer" title="Cliquez pour changer le logo">
                <img id="logoImage" src="asset/logo_gemef_galble_03.png" alt="Logo GEMEF" style="display: block;">
            </div>
            <div class="header-title">
                <h1>Formation Poste Extrusion</h1>
                <p>GEMEF Industries - Fiche de suivi des competences</p>
            </div>
        </div>
        <div class="header-actions">
            <button class="btn btn-secondary" onclick="resetData()">&#8635; Reinitialiser</button>
            <button class="btn btn-secondary" onclick="showExportModal()">&#128229; Exporter</button>
            <button class="btn btn-secondary" onclick="document.getElementById('importFile').click()">&#128228; Importer</button>
            <button class="btn btn-primary" onclick="exportPDF()">&#128196; Exporter PDF</button>
            <input type="file" id="importFile" class="hidden-input" accept=".json" onchange="importData(event)">
        </div>
    </header>
    <div class="container">
        <!-- Barre de profils -->
        <div class="profile-bar">
            <label>Profil :</label>
            <select id="profileSelect" class="profile-select" onchange="switchProfile()">
                <option value="">-- Nouveau profil --</option>
            </select>
            <button class="profile-btn" onclick="createProfile()">+ Nouveau</button>
            <button class="profile-btn danger" onclick="deleteProfile()">Supprimer</button>
        </div>

        <div class="progress-overview">
            <div class="progress-header">
                <span class="progress-title">Progression globale</span>
                <span class="progress-percentage" id="globalPercentage">0%</span>
            </div>
            <div class="progress-bar-container">
                <div class="progress-bar" id="globalProgressBar" style="width: 0%"></div>
            </div>
            <div class="progress-stats">
                <div class="stat"><div class="stat-dot pending"></div><div class="stat-info"><span class="stat-count" id="pendingCount">0</span><span class="stat-label"> A acquerir</span></div></div>
                <div class="stat"><div class="stat-dot progress"></div><div class="stat-info"><span class="stat-count" id="progressCount">0</span><span class="stat-label"> En cours</span></div></div>
                <div class="stat"><div class="stat-dot acquired"></div><div class="stat-info"><span class="stat-count" id="acquiredCount">0</span><span class="stat-label"> Acquis</span></div></div>
            </div>
        </div>

        <!-- Barre de filtres -->
        <div class="filters-bar">
            <span class="filters-label">Filtrer :</span>
            <button class="filter-btn active" onclick="setFilter('all')">Tout afficher</button>
            <button class="filter-btn filter-pending" onclick="setFilter('pending')">A acquerir</button>
            <button class="filter-btn filter-progress" onclick="setFilter('progress')">En cours</button>
            <button class="filter-btn filter-acquired" onclick="setFilter('acquired')">Acquis</button>
        </div>

        <div class="info-grid">
            <div class="info-card">
                <h3>Tuteur</h3>
                <div class="info-row"><span class="info-label">Nom</span><div class="info-value"><input type="text" id="tuteurNom" placeholder="Nom du tuteur"></div></div>
                <div class="info-row"><span class="info-label">Prenom</span><div class="info-value"><input type="text" id="tuteurPrenom" placeholder="Prenom du tuteur"></div></div>
            </div>
            <div class="info-card salarie-card">
                <h3>Salarie en formation</h3>
                <div class="info-row"><span class="info-label">Nom</span><div class="info-value"><input type="text" id="eleveNom" placeholder="Entrez le nom"></div></div>
                <div class="info-row"><span class="info-label">Prenom</span><div class="info-value"><input type="text" id="elevePrenom" placeholder="Entrez le prenom"></div></div>
            </div>
            <div class="info-card">
                <h3>Dates de formation</h3>
                <div class="info-row"><span class="info-label">Date de debut</span><div class="info-value"><input type="date" id="dateDebut"></div></div>
                <div class="info-row"><span class="info-label">Date de fin prev.</span><div class="info-value"><input type="date" id="dateFin"></div></div>
            </div>
            <div class="info-card">
                <h3>Informations</h3>
                <div class="info-row"><span class="info-label">Poste</span><div class="info-value"><input type="text" id="poste" value="Conducteur Extrusion" readonly style="background: #f5f5f5;"></div></div>
                <div class="info-row"><span class="info-label">Duree prevue</span><div class="info-value"><input type="text" id="duree" placeholder="Ex: 3 mois"></div></div>
            </div>
        </div>
        <div id="sectionsContainer"></div>
        <div class="comments-section">
            <h3>Commentaires / Axes d'amelioration</h3>
            <textarea id="comments" placeholder="Saisissez vos commentaires et axes d'amelioration ici..."></textarea>
        </div>
        <div class="signatures-grid">
            <div class="signature-card">
                <h4>Tuteur</h4>
                <div class="signature-field"><label>Date</label><input type="date" id="signatureTuteurDate"></div>
                <div class="signature-canvas-container">
                    <label style="display: block; font-size: 12px; color: #666; margin-bottom: 5px;">Signature</label>
                    <canvas id="signatureTuteur" class="signature-canvas"></canvas>
                    <button class="clear-signature" onclick="clearSignature('signatureTuteur')">Effacer</button>
                </div>
            </div>
            <div class="signature-card">
                <h4>Eleve</h4>
                <div class="signature-field"><label>Date</label><input type="date" id="signatureEleveDate"></div>
                <div class="signature-canvas-container">
                    <label style="display: block; font-size: 12px; color: #666; margin-bottom: 5px;">Signature</label>
                    <canvas id="signatureEleve" class="signature-canvas"></canvas>
                    <button class="clear-signature" onclick="clearSignature('signatureEleve')">Effacer</button>
                </div>
            </div>
            <div class="signature-card">
                <h4>Chef de poste</h4>
                <div class="signature-field"><label>Date</label><input type="date" id="signatureChefDate"></div>
                <div class="signature-canvas-container">
                    <label style="display: block; font-size: 12px; color: #666; margin-bottom: 5px;">Signature</label>
                    <canvas id="signatureChef" class="signature-canvas"></canvas>
                    <button class="clear-signature" onclick="clearSignature('signatureChef')">Effacer</button>
                </div>
            </div>
        </div>
    </div>
    <footer class="footer">GEMEF Industries - Fiche de formation Conducteur Extrusion - <span id="currentDate"></span></footer>
    <div class="notification" id="notification">&#10003; Donnees sauvegardees</div>

    <!-- Modal Export -->
    <div class="modal-overlay" id="exportModal">
        <div class="modal">
            <h3>Exporter les donnees</h3>
            <p style="margin-bottom: 15px; color: #666;">Telechargez un fichier JSON contenant toutes vos donnees. Vous pourrez le reimporter plus tard ou sur un autre appareil.</p>
            <div class="modal-actions">
                <button class="btn btn-secondary" onclick="closeExportModal()">Annuler</button>
                <button class="btn btn-success" onclick="exportJSON()">Telecharger JSON</button>
            </div>
        </div>
    </div>

    <script>
        var formationData = {
            sections: [
                { id: 1, title: "Securite / Prerequis / Controles prealables", tasks: [
                    "Presentation generale de l'atelier (personnel, fonctionnement)",
                    "Sens d'evacuation et issues de secours",
                    "Emplacement des differents arrets d'urgence",
                    "Regles de securite : conduite chariot (si CACES) + manipulations MP + utilisation outils"
                ]},
                { id: 2, title: "Preparer les installations", tasks: [
                    "Monter les lignes en debut semaine (mouzon, doseurs, etc.)",
                    "Monter les plaques avant, les filieres et granulateurs",
                    "S'assurer de la disponibilite des MP pour les satellites",
                    "Brancher les satellites",
                    "Installer la Comitrole",
                    "Choisir et installer la grille de la Comitrole"
                ]},
                { id: 3, title: "Demarrer les installations", tasks: [
                    "Controler la proprete de la ligne",
                    "Piloter les transferts de farine",
                    "Charger la recette sur Extruvision et la controler",
                    "Demarrer la ligne avec Extruvision",
                    "Mettre a 0 le totalisateur Ktron",
                    "Demarrer la fabrication pres de l'extrudeur",
                    "Creer et modifier les etapes de demarrage-arret Extruvision"
                ]},
                { id: 4, title: "Piloter les installations", tasks: [
                    "Regler les parametres machine (P, Amp, etc.) par rapport a ses specificites",
                    "Regler les parametres machine par rapport a la qualite des produits",
                    "Modifier un point de fonctionnement",
                    "Piloter les secheurs et refroidisseurs",
                    "Surveiller le fonctionnement de la Comitrole",
                    "Surveiller le fonctionnement des satellites",
                    "Demarrer la station sirop en debut de semaine et anticiper l'arret en fin de semaine"
                ]},
                { id: 5, title: "Controles en cours de poste / Qualite", tasks: [
                    "Realiser les prises echantillons aux frequences definies par le Controle Qualite",
                    "Realiser l'ensemble des controles qualite (densite, granulometrie, taille des grains, couleurs, humidite, etc.)",
                    "Enregistrer les resultats des controles qualite sur les fiches d'auto-controles",
                    "Decider de la conformite d'un produit et de sa destination",
                    "En cas de NC, communiquer avec les operateurs Conditionnement pour isoler et bloquer les produits NC",
                    "Decider d'arreter ou non la production en cas de NC",
                    "Connaitre les regles qualite en vigueur au sein de l'Extrusion",
                    "Appliquer les differents protocoles de fabrication (standard, BBF, GF)"
                ]},
                { id: 6, title: "Superviser les lignes", tasks: [
                    "Choisir et lancer la recette de la station sirop",
                    "Utiliser Extruvision au quotidien",
                    "Utiliser les courbes d'Extruvision pour analyse de probleme",
                    "Creer une courbe Extruvision"
                ]},
                { id: 7, title: "Regler les installations", tasks: [
                    "Regler les granulateurs",
                    "Controler le fonctionnement des DPM et barreaux aimantes avec operateurs Conditionnement",
                    "Tester les debits des satellites"
                ]},
                { id: 8, title: "Coordonner l'activite", tasks: [
                    "Suivre la consommation de melange a extruder",
                    "Approvisionner le materiel et consommable hygiene et nettoyage",
                    "Consulter et mettre a jour le planning Excel"
                ]},
                { id: 9, title: "Transmettre les informations", tasks: [
                    "Imprimer les rapports instantanes",
                    "Remplir les fiches de NC et les transmettre",
                    "Isoler et identifier un produit NC",
                    "Saisir les entrees - sorties et fin de fabrication en stock dans X3",
                    "Consulter et mettre a jour le planning Excel",
                    "Imprimer et exploiter les rapports de fin d'OF",
                    "Renseigner les plannings de nettoyage",
                    "Savoir effectuer une passation de consignes entre 2 postes"
                ]},
                { id: 10, title: "Gerer les outillages", tasks: [
                    "Preparer les filieres sales pour nettoyage",
                    "Receptionner les filieres propres",
                    "Nettoyer les filieres",
                    "Utiliser correctement ses outils"
                ]},
                { id: 11, title: "Assurer le bon etat technique des installations", tasks: [
                    "Remplir une feuille de Demande d'Intervention (DI)",
                    "Remplacer un profil de vis",
                    "Installer de nouveaux elements de vis",
                    "Controle usure du profil et entrefer",
                    "Identifier une panne et demander ou realiser une intervention adaptee"
                ]},
                { id: 12, title: "Maintenir ses connaissances", tasks: [
                    "Utiliser les instructions techniques disponibles",
                    "Appliquer et participer a l'evolution des procedures",
                    "Faire des propositions d'amelioration"
                ]},
                { id: 13, title: "Nettoyer / Ranger", tasks: [
                    "Nettoyer les differentes installations en fonction des procedures en place",
                    "Nettoyer les sols",
                    "Vider les differentes poubelles",
                    "Ranger l'atelier (aspirateur, balais, pelles ...)",
                    "Participer au nettoyage de fin de semaine"
                ]},
                { id: 14, title: "Comportement / Attitudes", tasks: [
                    "Signaler tout dysfonctionnement aux services competents : Maintenance si defaut machines, Magasin si rupture matieres, CDP si produits non conforme",
                    "Signaler a ses collegues tout depart du poste (pause, administratif, etc.)",
                    "Apporter son aide a ses collegues en cas de surcharge de travail"
                ]}
            ]
        };

        var taskStatus = {};
        var taskHistory = {};
        var currentFilter = 'all';
        var signatureCanvases = {};
        var customLogo = null;
        var currentProfile = null;

        document.addEventListener('DOMContentLoaded', function() {
            loadProfiles();
            loadData();
            renderSections();
            updateProgress();
            setupAutoSave();
            initSignatureCanvases();
            document.getElementById('currentDate').textContent = new Date().toLocaleDateString('fr-FR');
        });

        // ===== GESTION DES PROFILS =====
        function getProfileKey(profileId) {
            return 'gemef-formation-' + profileId;
        }

        function loadProfiles() {
            var profiles = JSON.parse(localStorage.getItem('gemef-profiles') || '[]');
            var select = document.getElementById('profileSelect');
            select.innerHTML = '<option value="">-- Selectionner un profil --</option>';
            profiles.forEach(function(profile) {
                var option = document.createElement('option');
                option.value = profile.id;
                option.textContent = profile.name + ' (' + profile.progress + '%)';
                select.appendChild(option);
            });
            // Selectionner le dernier profil utilise
            var lastProfile = localStorage.getItem('gemef-last-profile');
            if (lastProfile && profiles.find(function(p) { return p.id === lastProfile; })) {
                select.value = lastProfile;
                currentProfile = lastProfile;
            }
        }

        function createProfile() {
            var nom = prompt('Nom du salarie en formation:');
            if (!nom || nom.trim() === '') return;

            var prenom = prompt('Prenom:');
            if (!prenom || prenom.trim() === '') return;

            var profileId = Date.now().toString();
            var profileName = nom.trim() + ' ' + prenom.trim();

            var profiles = JSON.parse(localStorage.getItem('gemef-profiles') || '[]');
            profiles.push({ id: profileId, name: profileName, progress: 0 });
            localStorage.setItem('gemef-profiles', JSON.stringify(profiles));

            // Initialiser les donnees du profil
            var initialData = {
                taskStatus: {},
                taskHistory: {},
                formInfo: {
                    eleveNom: nom.trim(),
                    elevePrenom: prenom.trim()
                }
            };
            localStorage.setItem(getProfileKey(profileId), JSON.stringify(initialData));

            currentProfile = profileId;
            localStorage.setItem('gemef-last-profile', profileId);
            loadProfiles();
            document.getElementById('profileSelect').value = profileId;
            location.reload();
        }

        function switchProfile() {
            var select = document.getElementById('profileSelect');
            var profileId = select.value;

            if (!profileId) {
                createProfile();
                return;
            }

            currentProfile = profileId;
            localStorage.setItem('gemef-last-profile', profileId);
            location.reload();
        }

        function deleteProfile() {
            if (!currentProfile) {
                alert('Aucun profil selectionne');
                return;
            }

            var profiles = JSON.parse(localStorage.getItem('gemef-profiles') || '[]');
            var profile = profiles.find(function(p) { return p.id === currentProfile; });

            if (!confirm('Supprimer le profil "' + profile.name + '" ? Cette action est irreversible.')) return;

            // Supprimer les donnees du profil
            localStorage.removeItem(getProfileKey(currentProfile));

            // Retirer de la liste
            profiles = profiles.filter(function(p) { return p.id !== currentProfile; });
            localStorage.setItem('gemef-profiles', JSON.stringify(profiles));

            currentProfile = null;
            localStorage.removeItem('gemef-last-profile');
            location.reload();
        }

        function updateProfileProgress() {
            if (!currentProfile) return;
            var profiles = JSON.parse(localStorage.getItem('gemef-profiles') || '[]');
            var totalTasks = 0, acquiredCount = 0;
            formationData.sections.forEach(function(section) {
                section.tasks.forEach(function(_, index) {
                    totalTasks++;
                    if (taskStatus[section.id + '-' + index] === 'acquired') acquiredCount++;
                });
            });
            var progress = Math.round((acquiredCount / totalTasks) * 100);
            profiles = profiles.map(function(p) {
                if (p.id === currentProfile) p.progress = progress;
                return p;
            });
            localStorage.setItem('gemef-profiles', JSON.stringify(profiles));
        }

        // ===== SIGNATURE CANVAS =====
        function initSignatureCanvases() {
            var canvasIds = ['signatureTuteur', 'signatureEleve', 'signatureChef'];
            canvasIds.forEach(function(id) {
                var canvas = document.getElementById(id);
                var ctx = canvas.getContext('2d');

                // Set canvas size
                var rect = canvas.getBoundingClientRect();
                canvas.width = rect.width;
                canvas.height = rect.height;

                signatureCanvases[id] = {
                    canvas: canvas,
                    ctx: ctx,
                    drawing: false,
                    lastX: 0,
                    lastY: 0
                };

                // Load saved signature if exists
                if (!currentProfile) return;
                var saved = localStorage.getItem(getProfileKey(currentProfile));
                if (saved) {
                    var data = JSON.parse(saved);
                    if (data.signatures && data.signatures[id]) {
                        var img = new Image();
                        img.onload = function() {
                            ctx.drawImage(img, 0, 0);
                        };
                        img.src = data.signatures[id];
                    }
                }

                // Mouse events
                canvas.addEventListener('mousedown', function(e) { startDrawing(id, e); });
                canvas.addEventListener('mousemove', function(e) { draw(id, e); });
                canvas.addEventListener('mouseup', function() { stopDrawing(id); });
                canvas.addEventListener('mouseout', function() { stopDrawing(id); });

                // Touch events
                canvas.addEventListener('touchstart', function(e) {
                    e.preventDefault();
                    var touch = e.touches[0];
                    startDrawing(id, touch);
                });
                canvas.addEventListener('touchmove', function(e) {
                    e.preventDefault();
                    var touch = e.touches[0];
                    draw(id, touch);
                });
                canvas.addEventListener('touchend', function() { stopDrawing(id); });
            });
        }

        function getCanvasCoords(id, e) {
            var canvas = signatureCanvases[id].canvas;
            var rect = canvas.getBoundingClientRect();
            return {
                x: (e.clientX - rect.left) * (canvas.width / rect.width),
                y: (e.clientY - rect.top) * (canvas.height / rect.height)
            };
        }

        function startDrawing(id, e) {
            var sig = signatureCanvases[id];
            sig.drawing = true;
            var coords = getCanvasCoords(id, e);
            sig.lastX = coords.x;
            sig.lastY = coords.y;
        }

        function draw(id, e) {
            var sig = signatureCanvases[id];
            if (!sig.drawing) return;

            var coords = getCanvasCoords(id, e);
            sig.ctx.beginPath();
            sig.ctx.moveTo(sig.lastX, sig.lastY);
            sig.ctx.lineTo(coords.x, coords.y);
            sig.ctx.strokeStyle = '#2C2C2C';
            sig.ctx.lineWidth = 2;
            sig.ctx.lineCap = 'round';
            sig.ctx.stroke();

            sig.lastX = coords.x;
            sig.lastY = coords.y;
        }

        function stopDrawing(id) {
            var sig = signatureCanvases[id];
            if (sig.drawing) {
                sig.drawing = false;
                saveData();
            }
        }

        function clearSignature(id) {
            var sig = signatureCanvases[id];
            sig.ctx.clearRect(0, 0, sig.canvas.width, sig.canvas.height);
            saveData();
            showNotification('Signature effacee');
        }

        // ===== LOGO UPLOAD =====
        function handleLogoUpload(event) {
            var file = event.target.files[0];
            if (file && file.type.startsWith('image/')) {
                var reader = new FileReader();
                reader.onload = function(e) {
                    customLogo = e.target.result;
                    document.getElementById('logoText').style.display = 'none';
                    var logoImg = document.getElementById('logoImage');
                    logoImg.src = customLogo;
                    logoImg.style.display = 'block';
                    saveData();
                    showNotification('Logo mis a jour');
                };
                reader.readAsDataURL(file);
            }
        }

        // ===== FILTERS =====
        function setFilter(filter) {
            currentFilter = filter;

            // Update filter buttons
            document.querySelectorAll('.filter-btn').forEach(function(btn) {
                btn.classList.remove('active');
            });
            event.target.classList.add('active');

            // Apply filter
            applyFilter();
        }

        function applyFilter() {
            formationData.sections.forEach(function(section) {
                var sectionEl = document.getElementById('section-' + section.id);
                var tasks = sectionEl.querySelectorAll('.task');
                var visibleTasks = 0;

                tasks.forEach(function(taskEl, index) {
                    var status = getTaskStatus(section.id, index);
                    if (currentFilter === 'all' || status === currentFilter) {
                        taskEl.classList.remove('hidden');
                        visibleTasks++;
                    } else {
                        taskEl.classList.add('hidden');
                    }
                });

                // Hide section if no visible tasks
                if (visibleTasks === 0 && currentFilter !== 'all') {
                    sectionEl.classList.add('hidden');
                } else {
                    sectionEl.classList.remove('hidden');
                }
            });
        }

        // ===== EXPORT/IMPORT =====
        function showExportModal() {
            document.getElementById('exportModal').classList.add('show');
        }

        function closeExportModal() {
            document.getElementById('exportModal').classList.remove('show');
        }

        function exportJSON() {
            var signatures = {};
            ['signatureTuteur', 'signatureEleve', 'signatureChef'].forEach(function(id) {
                var canvas = document.getElementById(id);
                signatures[id] = canvas.toDataURL();
            });

            var data = {
                exportDate: new Date().toISOString(),
                version: '2.0',
                taskStatus: taskStatus,
                taskHistory: taskHistory,
                customLogo: customLogo,
                signatures: signatures,
                formInfo: {
                    tuteurNom: document.getElementById('tuteurNom').value,
                    tuteurPrenom: document.getElementById('tuteurPrenom').value,
                    eleveNom: document.getElementById('eleveNom').value,
                    elevePrenom: document.getElementById('elevePrenom').value,
                    dateDebut: document.getElementById('dateDebut').value,
                    dateFin: document.getElementById('dateFin').value,
                    duree: document.getElementById('duree').value,
                    comments: document.getElementById('comments').value,
                    signatureTuteurDate: document.getElementById('signatureTuteurDate').value,
                    signatureEleveDate: document.getElementById('signatureEleveDate').value,
                    signatureChefDate: document.getElementById('signatureChefDate').value
                }
            };

            var blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
            var url = URL.createObjectURL(blob);
            var a = document.createElement('a');
            a.href = url;
            var filename = 'formation-extrusion';
            if (data.formInfo.eleveNom) {
                filename += '-' + data.formInfo.eleveNom.toLowerCase().replace(/\s+/g, '-');
            }
            filename += '-' + new Date().toISOString().split('T')[0] + '.json';
            a.download = filename;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);

            closeExportModal();
            showNotification('Donnees exportees');
        }

        function importData(event) {
            var file = event.target.files[0];
            if (!file) return;

            var reader = new FileReader();
            reader.onload = function(e) {
                try {
                    var data = JSON.parse(e.target.result);

                    // Restore task status and history
                    taskStatus = data.taskStatus || {};
                    taskHistory = data.taskHistory || {};

                    // Restore custom logo
                    if (data.customLogo) {
                        customLogo = data.customLogo;
                        document.getElementById('logoText').style.display = 'none';
                        var logoImg = document.getElementById('logoImage');
                        logoImg.src = customLogo;
                        logoImg.style.display = 'block';
                    }

                    // Restore form info
                    if (data.formInfo) {
                        document.getElementById('tuteurNom').value = data.formInfo.tuteurNom || '';
                        document.getElementById('tuteurPrenom').value = data.formInfo.tuteurPrenom || '';
                        document.getElementById('eleveNom').value = data.formInfo.eleveNom || '';
                        document.getElementById('elevePrenom').value = data.formInfo.elevePrenom || '';
                        document.getElementById('dateDebut').value = data.formInfo.dateDebut || '';
                        document.getElementById('dateFin').value = data.formInfo.dateFin || '';
                        document.getElementById('duree').value = data.formInfo.duree || '';
                        document.getElementById('comments').value = data.formInfo.comments || '';
                        document.getElementById('signatureTuteurDate').value = data.formInfo.signatureTuteurDate || '';
                        document.getElementById('signatureEleveDate').value = data.formInfo.signatureEleveDate || '';
                        document.getElementById('signatureChefDate').value = data.formInfo.signatureChefDate || '';
                    }

                    // Restore signatures
                    if (data.signatures) {
                        ['signatureTuteur', 'signatureEleve', 'signatureChef'].forEach(function(id) {
                            if (data.signatures[id]) {
                                var canvas = document.getElementById(id);
                                var ctx = canvas.getContext('2d');
                                var img = new Image();
                                img.onload = function() {
                                    ctx.clearRect(0, 0, canvas.width, canvas.height);
                                    ctx.drawImage(img, 0, 0);
                                };
                                img.src = data.signatures[id];
                            }
                        });
                    }

                    renderSections();
                    updateProgress();
                    saveData();
                    showNotification('Donnees importees avec succes');
                } catch (err) {
                    alert('Erreur lors de l\'import du fichier. Verifiez que c\'est un fichier JSON valide.');
                }
            };
            reader.readAsText(file);
            event.target.value = '';
        }

        // ===== RENDER SECTIONS =====
        function renderSections() {
            var container = document.getElementById('sectionsContainer');
            container.innerHTML = '';
            formationData.sections.forEach(function(section) {
                var sectionEl = document.createElement('div');
                sectionEl.className = 'section';
                sectionEl.id = 'section-' + section.id;
                var sectionProgress = calculateSectionProgress(section.id);
                sectionEl.innerHTML =
                    '<div class="section-header" onclick="toggleSection(' + section.id + ')">' +
                        '<div class="section-title"><span class="section-number">' + section.id + '</span>' + section.title + '</div>' +
                        '<div class="section-progress">' +
                            '<div class="section-progress-bar"><div class="section-progress-fill" id="progress-fill-' + section.id + '" style="width: ' + sectionProgress + '%"></div></div>' +
                            '<span class="section-progress-text" id="progress-text-' + section.id + '">' + sectionProgress + '%</span>' +
                            '<span class="toggle-icon">&#9660;</span>' +
                        '</div>' +
                    '</div>' +
                    '<div class="section-content">' +
                        section.tasks.map(function(task, index) {
                            var history = getTaskHistory(section.id, index);
                            var historyHtml = history ? '<div class="task-history">Modifie le ' + history + '</div>' : '';
                            return '<div class="task">' +
                                '<div class="task-main">' +
                                    '<div class="task-text">' + task + '</div>' +
                                    '<div class="task-status">' +
                                        '<button class="status-btn pending ' + (getTaskStatus(section.id, index) === 'pending' ? 'active' : '') + '" onclick="setStatus(' + section.id + ', ' + index + ', \'pending\')">A acquerir</button>' +
                                        '<button class="status-btn progress ' + (getTaskStatus(section.id, index) === 'progress' ? 'active' : '') + '" onclick="setStatus(' + section.id + ', ' + index + ', \'progress\')">En cours</button>' +
                                        '<button class="status-btn acquired ' + (getTaskStatus(section.id, index) === 'acquired' ? 'active' : '') + '" onclick="setStatus(' + section.id + ', ' + index + ', \'acquired\')">Acquis</button>' +
                                    '</div>' +
                                '</div>' +
                                historyHtml +
                            '</div>';
                        }).join('') +
                    '</div>';
                container.appendChild(sectionEl);
            });
            applyFilter();
        }

        function toggleSection(sectionId) { document.getElementById('section-' + sectionId).classList.toggle('collapsed'); }
        function expandAll() { document.querySelectorAll('.section').forEach(function(s) { s.classList.remove('collapsed'); }); }
        function getTaskStatus(sectionId, taskIndex) { return taskStatus[sectionId + '-' + taskIndex] || 'pending'; }
        function getTaskHistory(sectionId, taskIndex) { return taskHistory[sectionId + '-' + taskIndex] || ''; }

        function setStatus(sectionId, taskIndex, status) {
            var key = sectionId + '-' + taskIndex;
            var oldStatus = taskStatus[key] || 'pending';

            if (oldStatus !== status) {
                taskStatus[key] = status;
                taskHistory[key] = new Date().toLocaleDateString('fr-FR') + ' a ' + new Date().toLocaleTimeString('fr-FR', {hour: '2-digit', minute: '2-digit'});

                var section = document.getElementById('section-' + sectionId);
                var taskEl = section.querySelectorAll('.task')[taskIndex];
                taskEl.querySelectorAll('.status-btn').forEach(function(btn) {
                    btn.classList.remove('active');
                    if (btn.classList.contains(status)) btn.classList.add('active');
                });

                // Update history display
                var historyEl = taskEl.querySelector('.task-history');
                if (historyEl) {
                    historyEl.textContent = 'Modifie le ' + taskHistory[key];
                } else {
                    var historyDiv = document.createElement('div');
                    historyDiv.className = 'task-history';
                    historyDiv.textContent = 'Modifie le ' + taskHistory[key];
                    taskEl.appendChild(historyDiv);
                }

                updateProgress();
                saveData();
                applyFilter();
            }
        }

        function calculateSectionProgress(sectionId) {
            var section = formationData.sections.find(function(s) { return s.id === sectionId; });
            if (!section) return 0;
            var acquired = 0;
            section.tasks.forEach(function(_, index) { if (getTaskStatus(sectionId, index) === 'acquired') acquired++; });
            return Math.round((acquired / section.tasks.length) * 100);
        }

        function updateProgress() {
            var totalTasks = 0, pendingCount = 0, progressCount = 0, acquiredCount = 0;
            formationData.sections.forEach(function(section) {
                section.tasks.forEach(function(_, index) {
                    totalTasks++;
                    var status = getTaskStatus(section.id, index);
                    if (status === 'pending') pendingCount++;
                    else if (status === 'progress') progressCount++;
                    else if (status === 'acquired') acquiredCount++;
                });
                var sectionProgress = calculateSectionProgress(section.id);
                var fillEl = document.getElementById('progress-fill-' + section.id);
                var textEl = document.getElementById('progress-text-' + section.id);
                if (fillEl) fillEl.style.width = sectionProgress + '%';
                if (textEl) textEl.textContent = sectionProgress + '%';
            });
            var globalProgress = Math.round((acquiredCount / totalTasks) * 100);
            document.getElementById('globalPercentage').textContent = globalProgress + '%';
            document.getElementById('globalProgressBar').style.width = globalProgress + '%';
            document.getElementById('pendingCount').textContent = pendingCount;
            document.getElementById('progressCount').textContent = progressCount;
            document.getElementById('acquiredCount').textContent = acquiredCount;
        }

        function saveData() {
            var signatures = {};
            ['signatureTuteur', 'signatureEleve', 'signatureChef'].forEach(function(id) {
                var canvas = document.getElementById(id);
                if (canvas) {
                    signatures[id] = canvas.toDataURL();
                }
            });

            var data = {
                taskStatus: taskStatus,
                taskHistory: taskHistory,
                customLogo: customLogo,
                signatures: signatures,
                formInfo: {
                    tuteurNom: document.getElementById('tuteurNom').value,
                    tuteurPrenom: document.getElementById('tuteurPrenom').value,
                    eleveNom: document.getElementById('eleveNom').value,
                    elevePrenom: document.getElementById('elevePrenom').value,
                    dateDebut: document.getElementById('dateDebut').value,
                    dateFin: document.getElementById('dateFin').value,
                    duree: document.getElementById('duree').value,
                    comments: document.getElementById('comments').value,
                    signatureTuteurDate: document.getElementById('signatureTuteurDate').value,
                    signatureEleveDate: document.getElementById('signatureEleveDate').value,
                    signatureChefDate: document.getElementById('signatureChefDate').value
                }
            };
            if (currentProfile) {
                localStorage.setItem(getProfileKey(currentProfile), JSON.stringify(data));
                updateProfileProgress();
            }
        }

        function loadData() {
            if (!currentProfile) return;
            var saved = localStorage.getItem(getProfileKey(currentProfile));
            if (saved) {
                var data = JSON.parse(saved);
                taskStatus = data.taskStatus || {};
                taskHistory = data.taskHistory || {};
                customLogo = data.customLogo || null;

                // Load custom logo (si un logo personnalise a ete importe)
                if (customLogo) {
                    var logoImg = document.getElementById('logoImage');
                    if (logoImg) {
                        logoImg.src = customLogo;
                    }
                }

                if (data.formInfo) {
                    document.getElementById('tuteurNom').value = data.formInfo.tuteurNom || '';
                    document.getElementById('tuteurPrenom').value = data.formInfo.tuteurPrenom || '';
                    document.getElementById('eleveNom').value = data.formInfo.eleveNom || '';
                    document.getElementById('elevePrenom').value = data.formInfo.elevePrenom || '';
                    document.getElementById('dateDebut').value = data.formInfo.dateDebut || '';
                    document.getElementById('dateFin').value = data.formInfo.dateFin || '';
                    document.getElementById('duree').value = data.formInfo.duree || '';
                    document.getElementById('comments').value = data.formInfo.comments || '';
                    document.getElementById('signatureTuteurDate').value = data.formInfo.signatureTuteurDate || '';
                    document.getElementById('signatureEleveDate').value = data.formInfo.signatureEleveDate || '';
                    document.getElementById('signatureChefDate').value = data.formInfo.signatureChefDate || '';
                }
            }
        }

        function setupAutoSave() {
            document.querySelectorAll('input, textarea').forEach(function(input) {
                input.addEventListener('change', function() { saveData(); });
            });
        }

        function showNotification(message) {
            var notif = document.getElementById('notification');
            notif.innerHTML = '&#10003; ' + (message || 'Donnees sauvegardees');
            notif.classList.add('show');
            setTimeout(function() { notif.classList.remove('show'); }, 2000);
        }

        function resetData() {
            if (!currentProfile) {
                alert('Aucun profil selectionne');
                return;
            }
            if (confirm('Etes-vous sur de vouloir reinitialiser ce profil ? Cette action est irreversible.')) {
                var profiles = JSON.parse(localStorage.getItem('gemef-profiles') || '[]');
                var profile = profiles.find(function(p) { return p.id === currentProfile; });
                // Reinitialiser les donnees mais garder le nom
                var initialData = {
                    taskStatus: {},
                    taskHistory: {},
                    formInfo: {
                        eleveNom: profile ? profile.name.split(' ')[0] : '',
                        elevePrenom: profile ? profile.name.split(' ').slice(1).join(' ') : ''
                    }
                };
                localStorage.setItem(getProfileKey(currentProfile), JSON.stringify(initialData));
                // Mettre a jour le progress a 0
                profiles = profiles.map(function(p) {
                    if (p.id === currentProfile) p.progress = 0;
                    return p;
                });
                localStorage.setItem('gemef-profiles', JSON.stringify(profiles));
                location.reload();
            }
        }

        function exportPDF() {
            expandAll();
            currentFilter = 'all';
            applyFilter();
            setTimeout(function() { window.print(); }, 300);
        }
    </script>
</body>
</html>
