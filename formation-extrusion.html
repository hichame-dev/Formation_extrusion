<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Formation Poste Extrusion - GEMEF Industries</title>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Montserrat:wght@500;600;700;800&family=Roboto:wght@400;500;600;700&display=swap');
        :root {
            --gemef-orange: #E87722;
            --gemef-orange-dark: #C5611A;
            --gemef-gray: #4A4A4A;
            --status-pending: #E74C3C;
            --status-progress: #F39C12;
            --status-acquired: #27AE60;
            --bg-main: #F5F5F5;
            --bg-card: #FFFFFF;
            --border-color: #E0E0E0;
            --text-primary: #2C2C2C;
            --text-secondary: #666666;
        }
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: 'Roboto', Arial, Helvetica, sans-serif; background: var(--bg-main); color: var(--text-primary); line-height: 1.5; }
        .header { background: linear-gradient(135deg, var(--gemef-gray) 0%, #2C2C2C 100%); color: white; padding: 20px 30px; display: flex; align-items: center; justify-content: space-between; box-shadow: 0 4px 20px rgba(0,0,0,0.15); position: sticky; top: 0; z-index: 100; }
        .logo-section { display: flex; align-items: center; gap: 20px; }
        .logo { width: 70px; height: 70px; background: var(--gemef-orange); border-radius: 8px; display: flex; align-items: center; justify-content: center; font-family: 'Montserrat', Arial, sans-serif; font-weight: 700; font-size: 28px; color: white; overflow: hidden; cursor: pointer; position: relative; }
        .logo img { width: 100%; height: 100%; object-fit: contain; }
        .logo-upload { position: absolute; top: 0; left: 0; width: 100%; height: 100%; opacity: 0; cursor: pointer; }
        .header-title h1 { font-family: 'Montserrat', Arial, sans-serif; font-size: 28px; font-weight: 700; text-transform: uppercase; }
        .header-title p { font-size: 14px; opacity: 0.8; }
        .header-actions { display: flex; gap: 12px; flex-wrap: wrap; }
        .btn { padding: 12px 24px; border: none; border-radius: 6px; font-family: 'Roboto', Arial, sans-serif; font-weight: 600; font-size: 14px; cursor: pointer; transition: all 0.2s ease; display: flex; align-items: center; gap: 8px; }
        .btn-primary { background: var(--gemef-orange); color: white; }
        .btn-primary:hover { background: var(--gemef-orange-dark); transform: translateY(-2px); }
        .btn-secondary { background: rgba(255,255,255,0.1); color: white; border: 1px solid rgba(255,255,255,0.3); }
        .btn-secondary:hover { background: rgba(255,255,255,0.2); }
        .btn-success { background: var(--status-acquired); color: white; }
        .btn-success:hover { background: #219a52; }
        .container { max-width: 1200px; margin: 0 auto; padding: 30px; }
        .progress-overview { background: var(--bg-card); border-radius: 12px; padding: 25px 30px; margin-bottom: 30px; box-shadow: 0 2px 12px rgba(0,0,0,0.06); border: 1px solid var(--border-color); }
        .progress-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; }
        .progress-title { font-family: 'Montserrat', Arial, sans-serif; font-size: 20px; font-weight: 600; color: var(--gemef-gray); text-transform: uppercase; }
        .progress-percentage { font-size: 36px; font-weight: 800; color: var(--gemef-orange); }
        .progress-bar-container { background: #E8E8E8; height: 12px; border-radius: 6px; overflow: hidden; margin-bottom: 20px; }
        .progress-bar { height: 100%; background: linear-gradient(90deg, var(--gemef-orange) 0%, var(--status-acquired) 100%); border-radius: 6px; transition: width 0.5s ease; }
        .progress-stats { display: flex; gap: 30px; flex-wrap: wrap; }
        .stat { display: flex; align-items: center; gap: 10px; }
        .stat-dot { width: 14px; height: 14px; border-radius: 50%; }
        .stat-dot.pending { background: var(--status-pending); }
        .stat-dot.progress { background: var(--status-progress); }
        .stat-dot.acquired { background: var(--status-acquired); }
        .stat-count { font-weight: 700; }
        .stat-label { color: var(--text-secondary); }

        /* Barre de profils */
        .profile-bar { background: linear-gradient(135deg, var(--gemef-orange) 0%, var(--gemef-orange-dark) 100%); border-radius: 12px; padding: 15px 25px; margin-bottom: 20px; box-shadow: 0 2px 12px rgba(0,0,0,0.1); display: flex; align-items: center; gap: 15px; flex-wrap: wrap; }
        .profile-bar label { color: white; font-weight: 600; }
        .profile-select { padding: 10px 15px; border: none; border-radius: 6px; font-family: 'Roboto', Arial, sans-serif; font-size: 14px; font-weight: 600; min-width: 200px; cursor: pointer; }
        .profile-select:focus { outline: 2px solid white; }
        .profile-btn { padding: 10px 16px; border: 2px solid white; border-radius: 6px; background: transparent; color: white; font-family: 'Roboto', Arial, sans-serif; font-weight: 600; font-size: 13px; cursor: pointer; transition: all 0.2s ease; }
        .profile-btn:hover { background: white; color: var(--gemef-orange); }
        .profile-btn.danger { border-color: #ffcccc; color: #ffcccc; }
        .profile-btn.danger:hover { background: #ffcccc; color: var(--status-pending); }

        /* Filtres */
        .filters-bar { background: var(--bg-card); border-radius: 12px; padding: 15px 25px; margin-bottom: 20px; box-shadow: 0 2px 12px rgba(0,0,0,0.06); border: 1px solid var(--border-color); display: flex; align-items: center; gap: 15px; flex-wrap: wrap; }
        .filters-label { font-weight: 600; color: var(--gemef-gray); }
        .filter-btn { padding: 8px 16px; border: 2px solid var(--border-color); border-radius: 20px; background: white; font-family: 'Roboto', Arial, sans-serif; font-weight: 600; font-size: 13px; cursor: pointer; transition: all 0.2s ease; }
        .filter-btn:hover { border-color: var(--gemef-orange); }
        .filter-btn.active { background: var(--gemef-orange); color: white; border-color: var(--gemef-orange); }
        .filter-btn.filter-pending.active { background: var(--status-pending); border-color: var(--status-pending); }
        .filter-btn.filter-progress.active { background: var(--status-progress); border-color: var(--status-progress); }
        .filter-btn.filter-acquired.active { background: var(--status-acquired); border-color: var(--status-acquired); }

        .info-grid { display: grid; grid-template-columns: repeat(2, 1fr); gap: 20px; margin-bottom: 30px; }
        .info-card { background: var(--bg-card); border-radius: 12px; padding: 25px; box-shadow: 0 2px 12px rgba(0,0,0,0.06); border: 1px solid var(--border-color); }
        .info-card h3 { font-family: 'Montserrat', Arial, sans-serif; font-size: 16px; font-weight: 600; color: var(--gemef-orange); text-transform: uppercase; margin-bottom: 15px; padding-bottom: 10px; border-bottom: 2px solid var(--gemef-orange); }
        .info-row { display: flex; margin-bottom: 12px; }
        .info-label { width: 140px; font-weight: 500; color: var(--text-secondary); font-size: 14px; }
        .info-value { flex: 1; }
        .info-value input { width: 100%; padding: 8px 12px; border: 1px solid var(--border-color); border-radius: 6px; font-family: 'Roboto', Arial, sans-serif; font-size: 14px; }
        .info-value input:focus { outline: none; border-color: var(--gemef-orange); }

        /* Carte Salarie en formation - Style special */
        .info-card.salarie-card { background: linear-gradient(135deg, #FFF8F3 0%, #FFEFE5 100%); border: 2px solid var(--gemef-orange); box-shadow: 0 4px 20px rgba(232, 119, 34, 0.15); }
        .info-card.salarie-card h3 { font-size: 18px; background: var(--gemef-orange); color: white; margin: -25px -25px 20px -25px; padding: 15px 25px; border-radius: 10px 10px 0 0; border-bottom: none; }
        .info-card.salarie-card .info-row { margin-bottom: 18px; align-items: center; }
        .info-card.salarie-card .info-label { font-weight: 600; color: var(--gemef-gray); font-size: 15px; }
        .info-card.salarie-card .info-value input { padding: 12px 16px; font-size: 16px; font-weight: 600; border: 2px solid #E0D0C5; border-radius: 8px; background: white; }
        .info-card.salarie-card .info-value input:focus { border-color: var(--gemef-orange); box-shadow: 0 0 0 3px rgba(232, 119, 34, 0.2); }
        .section { background: var(--bg-card); border-radius: 12px; margin-bottom: 20px; box-shadow: 0 2px 12px rgba(0,0,0,0.06); border: 1px solid var(--border-color); overflow: hidden; }
        .section.hidden { display: none; }
        .section-header { background: linear-gradient(135deg, var(--gemef-gray) 0%, #3D3D3D 100%); color: white; padding: 18px 25px; display: flex; justify-content: space-between; align-items: center; cursor: pointer; }
        .section-header:hover { background: linear-gradient(135deg, #3D3D3D 0%, var(--gemef-gray) 100%); }
        .section-title { font-family: 'Montserrat', Arial, sans-serif; font-size: 18px; font-weight: 600; text-transform: uppercase; display: flex; align-items: center; gap: 12px; }
        .section-number { background: var(--gemef-orange); width: 32px; height: 32px; border-radius: 6px; display: flex; align-items: center; justify-content: center; font-weight: 700; }
        .section-progress { display: flex; align-items: center; gap: 15px; }
        .section-progress-bar { width: 120px; height: 8px; background: rgba(255,255,255,0.2); border-radius: 4px; overflow: hidden; }
        .section-progress-fill { height: 100%; background: var(--gemef-orange); border-radius: 4px; transition: width 0.3s ease; }
        .section-progress-text { font-size: 14px; font-weight: 600; min-width: 45px; }
        .toggle-icon { font-size: 20px; transition: transform 0.3s ease; }
        .section.collapsed .toggle-icon { transform: rotate(-90deg); }
        .section.collapsed .section-content { display: none; }
        .task { display: flex; align-items: flex-start; padding: 16px 25px; border-bottom: 1px solid var(--border-color); flex-direction: column; gap: 8px; }
        .task.hidden { display: none; }
        .task:last-child { border-bottom: none; }
        .task:hover { background: #FAFAFA; }
        .task-main { display: flex; align-items: center; width: 100%; }
        .task-text { flex: 1; font-size: 14px; padding-right: 20px; }
        .task-status { display: flex; gap: 8px; }
        .task-history { font-size: 11px; color: var(--text-secondary); padding-left: 5px; font-style: italic; }
        .status-btn { padding: 8px 16px; border: 2px solid transparent; border-radius: 6px; font-family: 'Roboto', Arial, sans-serif; font-weight: 600; font-size: 12px; cursor: pointer; transition: all 0.2s ease; text-transform: uppercase; }
        .status-btn.pending { background: #FDEAEA; color: var(--status-pending); }
        .status-btn.pending.active { background: var(--status-pending); color: white; }
        .status-btn.progress { background: #FEF5E7; color: var(--status-progress); }
        .status-btn.progress.active { background: var(--status-progress); color: white; }
        .status-btn.acquired { background: #E8F6EF; color: var(--status-acquired); }
        .status-btn.acquired.active { background: var(--status-acquired); color: white; }
        .status-btn:hover { transform: scale(1.05); }

        /* Menu deroulant Acquis */
        .acquis-select { padding: 8px 12px; border: 2px solid var(--status-acquired); border-radius: 6px; font-family: 'Roboto', Arial, sans-serif; font-weight: 600; font-size: 12px; cursor: pointer; background: #E8F6EF; color: var(--status-acquired); text-transform: uppercase; transition: all 0.2s ease; min-width: 120px; }
        .acquis-select:hover { transform: scale(1.05); }
        .acquis-select.active { background: var(--status-acquired); color: white; }
        .acquis-select:focus { outline: none; box-shadow: 0 0 0 3px rgba(39, 174, 96, 0.3); }
        .acquis-select option { background: white; color: var(--text-primary); font-weight: 500; }
        .comments-section { background: var(--bg-card); border-radius: 12px; padding: 25px; margin-bottom: 30px; box-shadow: 0 2px 12px rgba(0,0,0,0.06); border: 1px solid var(--border-color); }
        .comments-section h3 { font-family: 'Montserrat', Arial, sans-serif; font-size: 18px; font-weight: 600; color: var(--gemef-gray); text-transform: uppercase; margin-bottom: 15px; }
        .comments-section textarea { width: 100%; min-height: 120px; padding: 15px; border: 1px solid var(--border-color); border-radius: 8px; font-family: 'Roboto', Arial, sans-serif; font-size: 14px; resize: vertical; }
        .comments-section textarea:focus { outline: none; border-color: var(--gemef-orange); }
        .signatures-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 20px; margin-bottom: 30px; }
        .signature-card { background: var(--bg-card); border-radius: 12px; padding: 25px; box-shadow: 0 2px 12px rgba(0,0,0,0.06); border: 1px solid var(--border-color); text-align: center; }
        .signature-card h4 { font-family: 'Montserrat', Arial, sans-serif; font-size: 16px; font-weight: 600; color: var(--gemef-orange); text-transform: uppercase; margin-bottom: 15px; }
        .signature-field { margin-bottom: 12px; }
        .signature-field label { display: block; font-size: 12px; color: var(--text-secondary); margin-bottom: 5px; }
        .signature-field input { width: 100%; padding: 10px; border: 1px solid var(--border-color); border-radius: 6px; font-family: 'Roboto', Arial, sans-serif; font-size: 14px; text-align: center; }
        .signature-field input:focus { outline: none; border-color: var(--gemef-orange); }

        /* Signature Canvas */
        .signature-canvas-container { position: relative; margin-top: 10px; }
        .signature-canvas { border: 2px dashed var(--border-color); border-radius: 8px; background: #FAFAFA; cursor: crosshair; touch-action: none; width: 100%; height: 100px; }
        .signature-canvas:hover { border-color: var(--gemef-orange); }
        .clear-signature { position: absolute; top: 5px; right: 5px; background: var(--status-pending); color: white; border: none; border-radius: 4px; padding: 4px 8px; font-size: 11px; cursor: pointer; }
        .clear-signature:hover { background: #c0392b; }

        .footer { text-align: center; padding: 20px; color: var(--text-secondary); font-size: 13px; }
        .notification { position: fixed; bottom: 30px; right: 30px; background: var(--status-acquired); color: white; padding: 15px 25px; border-radius: 8px; font-weight: 600; box-shadow: 0 4px 20px rgba(0,0,0,0.2); transform: translateY(100px); opacity: 0; transition: all 0.3s ease; z-index: 1000; }
        .notification.show { transform: translateY(0); opacity: 1; }

        /* Modal */
        .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.6); display: none; justify-content: center; align-items: center; z-index: 2000; backdrop-filter: blur(4px); }
        .modal-overlay.show { display: flex; }
        .modal { background: white; border-radius: 16px; padding: 0; max-width: 450px; width: 90%; max-height: 80vh; overflow-y: auto; box-shadow: 0 20px 60px rgba(0,0,0,0.3); }
        .modal-header { background: linear-gradient(135deg, var(--gemef-orange) 0%, var(--gemef-orange-dark) 100%); color: white; padding: 20px 25px; border-radius: 16px 16px 0 0; }
        .modal-header h3 { font-family: 'Montserrat', Arial, sans-serif; font-size: 22px; margin: 0; text-transform: uppercase; }
        .modal-header p { font-size: 13px; opacity: 0.9; margin-top: 5px; }
        .modal-body { padding: 25px; }
        .modal-field { margin-bottom: 20px; }
        .modal-field label { display: block; font-weight: 600; color: var(--gemef-gray); margin-bottom: 8px; font-size: 14px; }
        .modal-field input { width: 100%; padding: 14px 16px; border: 2px solid var(--border-color); border-radius: 10px; font-family: 'Roboto', Arial, sans-serif; font-size: 16px; transition: all 0.2s ease; }
        .modal-field input:focus { outline: none; border-color: var(--gemef-orange); box-shadow: 0 0 0 4px rgba(232, 119, 34, 0.15); }
        .modal-field input::placeholder { color: #aaa; }
        .modal-actions { display: flex; gap: 12px; padding: 0 25px 25px 25px; }
        .modal-actions .btn { flex: 1; justify-content: center; padding: 14px 20px; font-size: 15px; border-radius: 10px; }
        .modal-actions .btn-cancel { background: #f0f0f0; color: var(--gemef-gray); border: none; }
        .modal-actions .btn-cancel:hover { background: #e0e0e0; }

        /* Hidden file input */
        .hidden-input { display: none; }

        /* ===== RESPONSIVE MOBILE/TABLETTE ===== */
        @media screen and (max-width: 1024px) {
            .info-grid { grid-template-columns: repeat(2, 1fr); }
            .header { flex-direction: column; gap: 15px; text-align: center; }
            .header-actions { justify-content: center; }
        }

        @media screen and (max-width: 768px) {
            .container { padding: 15px; }
            .info-grid { grid-template-columns: 1fr; gap: 15px; }
            .header { padding: 15px; }
            .header-title h1 { font-size: 22px; }
            .header-actions { flex-wrap: wrap; justify-content: center; }
            .btn { padding: 10px 16px; font-size: 13px; }
            .profile-bar { flex-direction: column; gap: 10px; padding: 15px; }
            .profile-select { width: 100%; }
            .profile-btn { flex: 1; text-align: center; }
            .filters-bar { flex-direction: column; gap: 10px; }
            .filter-btn { width: 100%; }
            .section-header { flex-direction: column; gap: 10px; align-items: flex-start; }
            .section-progress { width: 100%; justify-content: space-between; }
            .section-progress-bar { flex: 1; }
            .task-main { flex-direction: column; gap: 10px; }
            .task-status { justify-content: flex-start; flex-wrap: wrap; }
            .status-btn { flex: 1; min-width: 80px; text-align: center; }
            .signatures-grid { grid-template-columns: 1fr; }
            .progress-stats { flex-direction: column; gap: 15px; }
        }

        @media screen and (max-width: 480px) {
            .header-title h1 { font-size: 18px; }
            .header-title p { font-size: 12px; }
            .logo { width: 50px; height: 50px; }
            .btn { padding: 8px 12px; font-size: 12px; }
            .section-title { font-size: 14px; }
            .section-number { width: 26px; height: 26px; font-size: 12px; }
            .task-text { font-size: 13px; }
            .status-btn { padding: 6px 10px; font-size: 11px; }
            .info-card { padding: 15px; }
            .info-card h3 { font-size: 14px; }
            .progress-percentage { font-size: 28px; }
            .progress-title { font-size: 16px; }
        }

        @media print {
            * { -webkit-print-color-adjust: exact !important; print-color-adjust: exact !important; }
            @page { size: A4; margin: 5mm; }
            body { font-size: 8px !important; line-height: 1.1 !important; }

            .header { position: static; background: white !important; color: black !important; box-shadow: none; border-bottom: 2px solid var(--gemef-orange); padding: 5px 10px !important; display: flex !important; }
            .header-actions { display: none !important; }
            .header-title h1 { font-size: 14px !important; }
            .header-title p { font-size: 9px !important; }
            .logo { width: 40px !important; height: 40px !important; }
            .logo-section { gap: 10px !important; }
            .profile-bar { display: none !important; }
            .filters-bar { display: none !important; }
            .container { padding: 5px !important; max-width: 100% !important; }

            /* Info cards - 4 en ligne */
            .info-grid { display: grid !important; grid-template-columns: repeat(4, 1fr) !important; gap: 5px !important; margin-bottom: 8px !important; }
            .info-card { padding: 5px 8px !important; border-radius: 4px !important; box-shadow: none !important; border: 1px solid #ddd !important; }
            .info-card h3 { font-size: 8px !important; margin-bottom: 4px !important; padding-bottom: 2px !important; border-bottom-width: 1px !important; }
            .info-card.salarie-card { background: white !important; border: 1px solid var(--gemef-orange) !important; box-shadow: none !important; }
            .info-card.salarie-card h3 { margin: -5px -8px 4px -8px !important; padding: 4px 8px !important; font-size: 8px !important; border-radius: 3px 3px 0 0 !important; }
            .info-row { margin-bottom: 2px !important; flex-direction: column !important; }
            .info-label { width: 100% !important; font-size: 7px !important; margin-bottom: 1px !important; }
            .info-value input { padding: 2px 4px !important; font-size: 8px !important; border-radius: 3px !important; }

            /* Progress masque pour gagner de la place */
            .progress-overview { display: none !important; }

            /* Sections ultra compactes */
            .section { margin-bottom: 4px !important; border-radius: 4px !important; page-break-inside: avoid !important; box-shadow: none !important; border: 1px solid #ddd !important; }
            .section.collapsed .section-content { display: block !important; }
            .section.hidden { display: block !important; }
            .section-header { padding: 4px 8px !important; background: #4A4A4A !important; }
            .section-title { font-size: 9px !important; gap: 5px !important; }
            .section-number { width: 16px !important; height: 16px !important; font-size: 8px !important; border-radius: 2px !important; }
            .section-progress { display: none !important; }
            .toggle-icon { display: none !important; }

            /* Taches en liste compacte */
            .section-content { padding: 3px 6px !important; display: block !important; column-count: 2 !important; column-gap: 10px !important; }
            .task { padding: 2px 4px !important; border-bottom: none !important; margin-bottom: 2px !important; break-inside: avoid !important; display: block !important; background: none !important; }
            .task.hidden { display: block !important; }
            .task-main { display: inline !important; }
            .task-text { font-size: 7px !important; display: inline !important; }
            .task-status { display: inline !important; margin-left: 3px !important; }
            .status-btn { padding: 1px 3px !important; font-size: 6px !important; border-radius: 2px !important; display: none !important; }
            .status-btn.active { display: inline !important; border: 1px solid currentColor !important; }
            .task-history { display: none !important; }

            /* Commentaires et signatures compacts */
            .comments-section { padding: 5px 8px !important; margin-bottom: 5px !important; box-shadow: none !important; border: 1px solid #ddd !important; }
            .comments-section h3 { font-size: 9px !important; margin-bottom: 3px !important; }
            .comments-section textarea { min-height: 25px !important; font-size: 8px !important; padding: 4px !important; }

            .signatures-grid { gap: 5px !important; margin-bottom: 5px !important; }
            .signature-card { padding: 5px !important; box-shadow: none !important; border: 1px solid #ddd !important; }
            .signature-card h4 { font-size: 8px !important; margin-bottom: 3px !important; }
            .signature-field { margin-bottom: 2px !important; }
            .signature-field label { font-size: 7px !important; margin-bottom: 1px !important; }
            .signature-field input { padding: 2px !important; font-size: 8px !important; }
            .signature-canvas { height: 35px !important; border: 1px solid #ccc !important; }
            .clear-signature { display: none !important; }
            .signature-canvas-container { margin-top: 3px !important; }

            .footer { padding: 3px !important; font-size: 7px !important; }
            .notification { display: none !important; }
            .modal-overlay { display: none !important; }
        }
        @media (max-width: 768px) {
            .header { flex-direction: column; gap: 15px; text-align: center; }
            .header-actions { justify-content: center; }
            .info-grid, .signatures-grid { grid-template-columns: 1fr; }
            .task-main { flex-direction: column; align-items: flex-start; gap: 12px; }
            .task-status { width: 100%; justify-content: space-between; }
            .status-btn { flex: 1; padding: 10px 8px; font-size: 11px; }
            .filters-bar { justify-content: center; }
        }
    </style>
</head>
<body>
    <header class="header">
        <div class="logo-section">
            <div class="logo" id="logoContainer" title="Cliquez pour changer le logo">
                <img id="logoImage" src="asset/logo_gemef_galble_03.png" alt="Logo GEMEF" style="display: block;">
            </div>
            <div class="header-title">
                <h1>Formation Poste Extrusion</h1>
                <p>GEMEF Industries - Fiche de suivi des competences</p>
            </div>
        </div>
        <div class="header-actions">
            <button class="btn btn-secondary" onclick="resetData()">&#8635; Reinitialiser</button>
            <button class="btn btn-secondary" onclick="showExportModal()">&#128229; Exporter</button>
            <button class="btn btn-secondary" onclick="document.getElementById('importFile').click()">&#128228; Importer</button>
            <button class="btn btn-primary" onclick="exportPDF()">&#128196; Exporter PDF</button>
            <input type="file" id="importFile" class="hidden-input" accept=".json" onchange="importData(event)">
        </div>
    </header>
    <div class="container">
        <!-- Barre de profils -->
        <div class="profile-bar">
            <label>Profil :</label>
            <select id="profileSelect" class="profile-select" onchange="switchProfile()">
                <option value="">-- Nouveau profil --</option>
            </select>
            <button class="profile-btn" onclick="createProfile()">+ Nouveau</button>
            <button class="profile-btn danger" onclick="deleteProfile()">Supprimer</button>
            <span style="border-left: 2px solid rgba(255,255,255,0.3); height: 24px; margin: 0 10px;"></span>
            <button class="profile-btn" onclick="showCloudModal()" id="cloudBtn">&#9729; Cloud Sync</button>
            <span id="cloudStatus" style="color: rgba(255,255,255,0.8); font-size: 12px;"></span>
        </div>

        <div class="progress-overview">
            <div class="progress-header">
                <span class="progress-title">Progression globale</span>
                <span class="progress-percentage" id="globalPercentage">0%</span>
            </div>
            <div class="progress-bar-container">
                <div class="progress-bar" id="globalProgressBar" style="width: 0%"></div>
            </div>
            <div class="progress-stats">
                <div class="stat"><div class="stat-dot pending"></div><div class="stat-info"><span class="stat-count" id="pendingCount">0</span><span class="stat-label"> A acquerir</span></div></div>
                <div class="stat"><div class="stat-dot progress"></div><div class="stat-info"><span class="stat-count" id="progressCount">0</span><span class="stat-label"> En cours</span></div></div>
                <div class="stat"><div class="stat-dot acquired"></div><div class="stat-info"><span class="stat-count" id="acquiredCount">0</span><span class="stat-label"> Acquis</span></div></div>
            </div>
        </div>

        <!-- Barre de filtres -->
        <div class="filters-bar">
            <span class="filters-label">Filtrer :</span>
            <button class="filter-btn active" onclick="setFilter('all')">Tout afficher</button>
            <button class="filter-btn filter-pending" onclick="setFilter('pending')">A acquerir</button>
            <button class="filter-btn filter-progress" onclick="setFilter('progress')">En cours</button>
            <button class="filter-btn filter-acquired" onclick="setFilter('acquired')">Acquis</button>
        </div>

        <div class="info-grid">
            <div class="info-card">
                <h3>Tuteur</h3>
                <div class="info-row"><span class="info-label">Nom</span><div class="info-value"><input type="text" id="tuteurNom" placeholder="Nom du tuteur"></div></div>
                <div class="info-row"><span class="info-label">Prenom</span><div class="info-value"><input type="text" id="tuteurPrenom" placeholder="Prenom du tuteur"></div></div>
            </div>
            <div class="info-card salarie-card">
                <h3>Salarie en formation</h3>
                <div class="info-row"><span class="info-label">Nom</span><div class="info-value"><input type="text" id="eleveNom" placeholder="Entrez le nom"></div></div>
                <div class="info-row"><span class="info-label">Prenom</span><div class="info-value"><input type="text" id="elevePrenom" placeholder="Entrez le prenom"></div></div>
            </div>
            <div class="info-card">
                <h3>Dates de formation</h3>
                <div class="info-row"><span class="info-label">Date de debut</span><div class="info-value"><input type="date" id="dateDebut"></div></div>
                <div class="info-row"><span class="info-label">Date de fin prev.</span><div class="info-value"><input type="date" id="dateFin"></div></div>
            </div>
            <div class="info-card">
                <h3>Informations</h3>
                <div class="info-row"><span class="info-label">Poste</span><div class="info-value"><input type="text" id="poste" value="Conducteur Extrusion" readonly style="background: #f5f5f5;"></div></div>
                <div class="info-row"><span class="info-label">Duree prevue</span><div class="info-value"><input type="text" id="duree" placeholder="Ex: 3 mois"></div></div>
            </div>
        </div>
        <div id="sectionsContainer"></div>
        <div class="comments-section">
            <h3>Commentaires / Axes d'amelioration</h3>
            <textarea id="comments" placeholder="Saisissez vos commentaires et axes d'amelioration ici..."></textarea>
        </div>
        <div class="signatures-grid">
            <div class="signature-card">
                <h4>Tuteur</h4>
                <div class="signature-field"><label>Date</label><input type="date" id="signatureTuteurDate"></div>
                <div class="signature-canvas-container">
                    <label style="display: block; font-size: 12px; color: #666; margin-bottom: 5px;">Signature</label>
                    <canvas id="signatureTuteur" class="signature-canvas"></canvas>
                    <button class="clear-signature" onclick="clearSignature('signatureTuteur')">Effacer</button>
                </div>
            </div>
            <div class="signature-card">
                <h4>Eleve</h4>
                <div class="signature-field"><label>Date</label><input type="date" id="signatureEleveDate"></div>
                <div class="signature-canvas-container">
                    <label style="display: block; font-size: 12px; color: #666; margin-bottom: 5px;">Signature</label>
                    <canvas id="signatureEleve" class="signature-canvas"></canvas>
                    <button class="clear-signature" onclick="clearSignature('signatureEleve')">Effacer</button>
                </div>
            </div>
            <div class="signature-card">
                <h4>Chef de poste</h4>
                <div class="signature-field"><label>Date</label><input type="date" id="signatureChefDate"></div>
                <div class="signature-canvas-container">
                    <label style="display: block; font-size: 12px; color: #666; margin-bottom: 5px;">Signature</label>
                    <canvas id="signatureChef" class="signature-canvas"></canvas>
                    <button class="clear-signature" onclick="clearSignature('signatureChef')">Effacer</button>
                </div>
            </div>
        </div>
    </div>
    <footer class="footer">GEMEF Industries - Fiche de formation Conducteur Extrusion - <span id="currentDate"></span></footer>
    <div class="notification" id="notification">&#10003; Donnees sauvegardees</div>

    <!-- Modal Export -->
    <div class="modal-overlay" id="exportModal">
        <div class="modal">
            <div class="modal-header">
                <h3>Exporter les donnees</h3>
                <p>Sauvegardez vos donnees en fichier JSON</p>
            </div>
            <div class="modal-body">
                <p style="color: #666;">Telechargez un fichier JSON contenant toutes vos donnees. Vous pourrez le reimporter plus tard ou sur un autre appareil.</p>
            </div>
            <div class="modal-actions">
                <button class="btn btn-cancel" onclick="closeExportModal()">Annuler</button>
                <button class="btn btn-success" onclick="exportJSON()">Telecharger JSON</button>
            </div>
        </div>
    </div>

    <!-- Modal Nouveau Profil -->
    <div class="modal-overlay" id="profileModal">
        <div class="modal">
            <div class="modal-header">
                <h3>Nouveau Profil</h3>
                <p>Creer un nouveau salarie en formation</p>
            </div>
            <div class="modal-body">
                <div class="modal-field">
                    <label for="newProfileNom">Nom du salarie</label>
                    <input type="text" id="newProfileNom" placeholder="Entrez le nom de famille" autocomplete="off">
                </div>
                <div class="modal-field">
                    <label for="newProfilePrenom">Prenom du salarie</label>
                    <input type="text" id="newProfilePrenom" placeholder="Entrez le prenom" autocomplete="off">
                </div>
            </div>
            <div class="modal-actions">
                <button class="btn btn-cancel" onclick="closeProfileModal()">Annuler</button>
                <button class="btn btn-primary" onclick="confirmCreateProfile()">Creer le profil</button>
            </div>
        </div>
    </div>

    <!-- Modal Confirmation Suppression -->
    <div class="modal-overlay" id="deleteModal">
        <div class="modal">
            <div class="modal-header" style="background: linear-gradient(135deg, #E74C3C 0%, #C0392B 100%);">
                <h3>Supprimer le profil</h3>
                <p>Cette action est irreversible</p>
            </div>
            <div class="modal-body">
                <p style="color: #666;">Etes-vous sur de vouloir supprimer le profil <strong id="deleteProfileName"></strong> ?</p>
                <p style="color: #E74C3C; font-size: 13px; margin-top: 10px;">Toutes les donnees de formation seront perdues.</p>
            </div>
            <div class="modal-actions">
                <button class="btn btn-cancel" onclick="closeDeleteModal()">Annuler</button>
                <button class="btn" style="background: #E74C3C; color: white;" onclick="confirmDeleteProfile()">Supprimer</button>
            </div>
        </div>
    </div>

    <!-- Modal Confirmation Reinitialisation -->
    <div class="modal-overlay" id="resetModal">
        <div class="modal">
            <div class="modal-header" style="background: linear-gradient(135deg, #F39C12 0%, #E67E22 100%);">
                <h3>Reinitialiser le profil</h3>
                <p>Remettre toutes les competences a zero</p>
            </div>
            <div class="modal-body">
                <p style="color: #666;">Etes-vous sur de vouloir reinitialiser le profil <strong id="resetProfileName"></strong> ?</p>
                <p style="color: #F39C12; font-size: 13px; margin-top: 10px;">Toutes les competences seront remises a "A acquerir".</p>
            </div>
            <div class="modal-actions">
                <button class="btn btn-cancel" onclick="closeResetModal()">Annuler</button>
                <button class="btn" style="background: #F39C12; color: white;" onclick="confirmResetProfile()">Reinitialiser</button>
            </div>
        </div>
    </div>

    <!-- Modal Alerte -->
    <div class="modal-overlay" id="alertModal">
        <div class="modal">
            <div class="modal-header" id="alertModalHeader">
                <h3 id="alertModalTitle">Information</h3>
            </div>
            <div class="modal-body">
                <p id="alertModalMessage" style="color: #666;"></p>
            </div>
            <div class="modal-actions">
                <button class="btn btn-primary" onclick="closeAlertModal()" style="flex: none; min-width: 120px;">OK</button>
            </div>
        </div>
    </div>

    <!-- Modal JSONBin Config -->
    <div class="modal-overlay" id="cloudModal">
        <div class="modal">
            <div class="modal-header" style="background: linear-gradient(135deg, #6366F1 0%, #4F46E5 100%);">
                <h3>&#9729; Synchronisation Cloud</h3>
                <p>JSONBin.io - Partage des profils</p>
            </div>
            <div class="modal-body">
                <div id="cloudSetup">
                    <p style="color: #666; margin-bottom: 15px; font-size: 13px;">Synchronisez les profils entre tous les utilisateurs via le cloud.</p>
                    <div class="modal-field">
                        <label for="jsonbinApiKey">Cle API (X-Master-Key)</label>
                        <input type="password" id="jsonbinApiKey" placeholder="$2a$10$..." autocomplete="off">
                    </div>
                    <div class="modal-field">
                        <label for="jsonbinBinId">Bin ID (optionnel - laissez vide pour creer)</label>
                        <input type="text" id="jsonbinBinId" placeholder="Ex: 65a1b2c3d4e5f6..." autocomplete="off">
                    </div>
                    <p style="color: #888; font-size: 11px; margin-top: 10px;">
                        1. Creez un compte sur <a href="https://jsonbin.io" target="_blank" style="color: #6366F1;">jsonbin.io</a><br>
                        2. Copiez votre X-Master-Key depuis les parametres<br>
                        3. Cliquez sur Connecter
                    </p>
                </div>
                <div id="cloudConnected" style="display: none; text-align: center;">
                    <p style="color: #27AE60; font-size: 18px; margin-bottom: 10px;">&#10003; Connecte au cloud</p>
                    <p style="color: #666; font-size: 13px;">Les profils sont synchronises automatiquement.</p>
                    <p style="color: #888; font-size: 11px; margin-top: 15px;">Bin ID: <code id="displayBinId" style="background: #f0f0f0; padding: 2px 6px; border-radius: 4px;"></code></p>
                </div>
            </div>
            <div class="modal-actions">
                <button class="btn btn-cancel" onclick="closeCloudModal()">Fermer</button>
                <button class="btn" id="cloudConnectBtn" style="background: #6366F1; color: white;" onclick="connectCloud()">Connecter</button>
                <button class="btn" id="cloudDisconnectBtn" style="background: #E74C3C; color: white; display: none;" onclick="disconnectCloud()">Deconnecter</button>
            </div>
        </div>
    </div>

    <script>
        var formationData = {
            sections: [
                { id: 1, title: "Securite / Prerequis / Controles prealables", tasks: [
                    "Presentation generale de l'atelier (personnel, fonctionnement)",
                    "Sens d'evacuation et issues de secours",
                    "Emplacement des differents arrets d'urgence",
                    "Regles de securite : conduite chariot (si CACES) + manipulations MP + utilisation outils"
                ]},
                { id: 2, title: "Preparer les installations", tasks: [
                    "Monter les lignes en debut semaine (mouzon, doseurs, etc.)",
                    "Monter les plaques avant, les filieres et granulateurs",
                    "S'assurer de la disponibilite des MP pour les satellites",
                    "Brancher les satellites",
                    "Installer la Comitrole",
                    "Choisir et installer la grille de la Comitrole"
                ]},
                { id: 3, title: "Demarrer les installations", tasks: [
                    "Controler la proprete de la ligne",
                    "Piloter les transferts de farine",
                    "Charger la recette sur Extruvision et la controler",
                    "Demarrer la ligne avec Extruvision",
                    "Mettre a 0 le totalisateur Ktron",
                    "Demarrer la fabrication pres de l'extrudeur",
                    "Creer et modifier les etapes de demarrage-arret Extruvision"
                ]},
                { id: 4, title: "Piloter les installations", tasks: [
                    "Regler les parametres machine (P, Amp, etc.) par rapport a ses specificites",
                    "Regler les parametres machine par rapport a la qualite des produits",
                    "Modifier un point de fonctionnement",
                    "Piloter les secheurs et refroidisseurs",
                    "Surveiller le fonctionnement de la Comitrole",
                    "Surveiller le fonctionnement des satellites",
                    "Demarrer la station sirop en debut de semaine et anticiper l'arret en fin de semaine"
                ]},
                { id: 5, title: "Controles en cours de poste / Qualite", tasks: [
                    "Realiser les prises echantillons aux frequences definies par le Controle Qualite",
                    "Realiser l'ensemble des controles qualite (densite, granulometrie, taille des grains, couleurs, humidite, etc.)",
                    "Enregistrer les resultats des controles qualite sur les fiches d'auto-controles",
                    "Decider de la conformite d'un produit et de sa destination",
                    "En cas de NC, communiquer avec les operateurs Conditionnement pour isoler et bloquer les produits NC",
                    "Decider d'arreter ou non la production en cas de NC",
                    "Connaitre les regles qualite en vigueur au sein de l'Extrusion",
                    "Appliquer les differents protocoles de fabrication (standard, BBF, GF)"
                ]},
                { id: 6, title: "Superviser les lignes", tasks: [
                    "Choisir et lancer la recette de la station sirop",
                    "Utiliser Extruvision au quotidien",
                    "Utiliser les courbes d'Extruvision pour analyse de probleme",
                    "Creer une courbe Extruvision"
                ]},
                { id: 7, title: "Regler les installations", tasks: [
                    "Regler les granulateurs",
                    "Controler le fonctionnement des DPM et barreaux aimantes avec operateurs Conditionnement",
                    "Tester les debits des satellites"
                ]},
                { id: 8, title: "Coordonner l'activite", tasks: [
                    "Suivre la consommation de melange a extruder",
                    "Approvisionner le materiel et consommable hygiene et nettoyage",
                    "Consulter et mettre a jour le planning Excel"
                ]},
                { id: 9, title: "Transmettre les informations", tasks: [
                    "Imprimer les rapports instantanes",
                    "Remplir les fiches de NC et les transmettre",
                    "Isoler et identifier un produit NC",
                    "Saisir les entrees - sorties et fin de fabrication en stock dans X3",
                    "Consulter et mettre a jour le planning Excel",
                    "Imprimer et exploiter les rapports de fin d'OF",
                    "Renseigner les plannings de nettoyage",
                    "Savoir effectuer une passation de consignes entre 2 postes"
                ]},
                { id: 10, title: "Gerer les outillages", tasks: [
                    "Preparer les filieres sales pour nettoyage",
                    "Receptionner les filieres propres",
                    "Nettoyer les filieres",
                    "Utiliser correctement ses outils"
                ]},
                { id: 11, title: "Assurer le bon etat technique des installations", tasks: [
                    "Remplir une feuille de Demande d'Intervention (DI)",
                    "Remplacer un profil de vis",
                    "Installer de nouveaux elements de vis",
                    "Controle usure du profil et entrefer",
                    "Identifier une panne et demander ou realiser une intervention adaptee"
                ]},
                { id: 12, title: "Maintenir ses connaissances", tasks: [
                    "Utiliser les instructions techniques disponibles",
                    "Appliquer et participer a l'evolution des procedures",
                    "Faire des propositions d'amelioration"
                ]},
                { id: 13, title: "Nettoyer / Ranger", tasks: [
                    "Nettoyer les differentes installations en fonction des procedures en place",
                    "Nettoyer les sols",
                    "Vider les differentes poubelles",
                    "Ranger l'atelier (aspirateur, balais, pelles ...)",
                    "Participer au nettoyage de fin de semaine",
                    "S'assurer qu'aucune matiere ou residu de la production precedente ne subsiste sur la ligne (verification complete avant demarrage d'une nouvelle production)"
                ]},
                { id: 14, title: "Comportement / Attitudes", tasks: [
                    "Signaler tout dysfonctionnement aux services competents : Maintenance si defaut machines, Magasin si rupture matieres, CDP si produits non conforme",
                    "Signaler a ses collegues tout depart du poste (pause, administratif, etc.)",
                    "Apporter son aide a ses collegues en cas de surcharge de travail"
                ]},
                { id: 15, title: "Securite Alimentaire / Hygiene", tasks: [
                    "Respecter les regles d'hygiene personnelle (tenue de travail propre, lavage des mains, port des EPI adequats)",
                    "Respecter les bonnes pratiques de fabrication alimentaire",
                    "Identifier et gerer les risques lies aux allergenes (procedures de nettoyage, separation des productions)",
                    "Prevenir les contaminations par corps etrangers (verre, metal, plastique dur)",
                    "Signaler toute non-conformite pouvant affecter la securite alimentaire",
                    "Respecter les procedures de nettoyage et desinfection specifiques aux zones alimentaires"
                ]},
                { id: 16, title: "Lecture d'un OF (Ordre de Fabrication)", tasks: [
                    "Identifier les informations essentielles d'un OF (numero, reference produit, quantite)",
                    "Lire et comprendre les specifications techniques (dimensions, tolerances, couleur)",
                    "Identifier la matiere premiere a utiliser et ses caracteristiques",
                    "Reperer les parametres machine preconises",
                    "Comprendre les instructions particulieres et les remarques client",
                    "Verifier la coherence entre l'OF et les matieres disponibles",
                    "Renseigner correctement les informations de suivi de production sur l'OF"
                ]}
            ]
        };

        var taskStatus = {};
        var taskHistory = {};
        var currentFilter = 'all';
        var signatureCanvases = {};
        var customLogo = null;
        var currentProfile = null;

        // JSONBin.io Cloud Config
        var cloudConfig = JSON.parse(localStorage.getItem('gemef-cloud-config') || 'null');

        document.addEventListener('DOMContentLoaded', async function() {
            // Charger depuis le cloud si configure
            if (cloudConfig && cloudConfig.apiKey && cloudConfig.binId) {
                await loadFromCloud();
                document.getElementById('cloudStatus').textContent = '‚óè Cloud';
                document.getElementById('cloudStatus').style.color = '#90EE90';
            }
            loadProfiles();
            loadData();
            renderSections();
            updateProgress();
            setupAutoSave();
            initSignatureCanvases();
            document.getElementById('currentDate').textContent = new Date().toLocaleDateString('fr-FR');
        });

        // ===== GESTION DES PROFILS =====
        function getProfileKey(profileId) {
            return 'gemef-formation-' + profileId;
        }

        function loadProfiles() {
            var profiles = JSON.parse(localStorage.getItem('gemef-profiles') || '[]');
            var select = document.getElementById('profileSelect');
            select.innerHTML = '<option value="">-- Selectionner un profil --</option>';
            profiles.forEach(function(profile) {
                var option = document.createElement('option');
                option.value = profile.id;
                option.textContent = profile.name + ' (' + profile.progress + '%)';
                select.appendChild(option);
            });
            // Selectionner le dernier profil utilise
            var lastProfile = localStorage.getItem('gemef-last-profile');
            if (lastProfile && profiles.find(function(p) { return p.id === lastProfile; })) {
                select.value = lastProfile;
                currentProfile = lastProfile;
            }
        }

        function createProfile() {
            document.getElementById('newProfileNom').value = '';
            document.getElementById('newProfilePrenom').value = '';
            document.getElementById('profileModal').classList.add('show');
            document.getElementById('newProfileNom').focus();
        }

        function closeProfileModal() {
            document.getElementById('profileModal').classList.remove('show');
        }

        async function confirmCreateProfile() {
            var nom = document.getElementById('newProfileNom').value;
            var prenom = document.getElementById('newProfilePrenom').value;

            if (!nom || nom.trim() === '') {
                showAlert('Veuillez entrer le nom du salarie', 'Champ requis', 'warning');
                return;
            }
            if (!prenom || prenom.trim() === '') {
                showAlert('Veuillez entrer le prenom du salarie', 'Champ requis', 'warning');
                return;
            }

            var profileId = Date.now().toString();
            var profileName = nom.trim() + ' ' + prenom.trim();
            var fileName = profileName.toLowerCase().replace(/\s+/g, '-').replace(/[^a-z0-9-]/g, '') + '.json';

            var profiles = JSON.parse(localStorage.getItem('gemef-profiles') || '[]');
            profiles.push({ id: profileId, name: profileName, progress: 0, fileName: fileName });
            localStorage.setItem('gemef-profiles', JSON.stringify(profiles));

            // Initialiser les donnees du profil
            var initialData = {
                taskStatus: {},
                taskHistory: {},
                formInfo: {
                    eleveNom: nom.trim(),
                    elevePrenom: prenom.trim()
                }
            };
            localStorage.setItem(getProfileKey(profileId), JSON.stringify(initialData));

            currentProfile = profileId;
            localStorage.setItem('gemef-last-profile', profileId);

            // Sauvegarder dans le cloud si connecte
            if (cloudConfig) {
                taskStatus = {};
                taskHistory = {};
                await saveToCloud();
            }

            closeProfileModal();
            location.reload();
        }

        function switchProfile() {
            var select = document.getElementById('profileSelect');
            var profileId = select.value;

            if (!profileId) {
                createProfile();
                return;
            }

            currentProfile = profileId;
            localStorage.setItem('gemef-last-profile', profileId);
            location.reload();
        }

        function deleteProfile() {
            if (!currentProfile) {
                showAlert('Veuillez d\'abord selectionner un profil', 'Aucun profil', 'warning');
                return;
            }

            var profiles = JSON.parse(localStorage.getItem('gemef-profiles') || '[]');
            var profile = profiles.find(function(p) { return p.id === currentProfile; });

            document.getElementById('deleteProfileName').textContent = profile.name;
            document.getElementById('deleteModal').classList.add('show');
        }

        function closeDeleteModal() {
            document.getElementById('deleteModal').classList.remove('show');
        }

        async function confirmDeleteProfile() {
            // Supprimer les donnees du profil
            localStorage.removeItem(getProfileKey(currentProfile));

            // Retirer de la liste
            var profiles = JSON.parse(localStorage.getItem('gemef-profiles') || '[]');
            profiles = profiles.filter(function(p) { return p.id !== currentProfile; });
            localStorage.setItem('gemef-profiles', JSON.stringify(profiles));

            // Synchroniser avec le cloud
            if (cloudConfig) {
                await saveToCloud();
            }

            currentProfile = null;
            localStorage.removeItem('gemef-last-profile');
            closeDeleteModal();
            location.reload();
        }

        function updateProfileProgress() {
            if (!currentProfile) return;
            var profiles = JSON.parse(localStorage.getItem('gemef-profiles') || '[]');
            var totalTasks = 0, acquiredCount = 0;
            formationData.sections.forEach(function(section) {
                section.tasks.forEach(function(_, index) {
                    totalTasks++;
                    var status = taskStatus[section.id + '-' + index] || '';
                    if (status.startsWith('acquired')) acquiredCount++;
                });
            });
            var progress = Math.round((acquiredCount / totalTasks) * 100);
            profiles = profiles.map(function(p) {
                if (p.id === currentProfile) p.progress = progress;
                return p;
            });
            localStorage.setItem('gemef-profiles', JSON.stringify(profiles));
        }

        // ===== JSONBIN.IO CLOUD SYNC =====
        function showCloudModal() {
            var modal = document.getElementById('cloudModal');
            if (cloudConfig && cloudConfig.binId) {
                document.getElementById('cloudSetup').style.display = 'none';
                document.getElementById('cloudConnected').style.display = 'block';
                document.getElementById('displayBinId').textContent = cloudConfig.binId;
                document.getElementById('cloudConnectBtn').style.display = 'none';
                document.getElementById('cloudDisconnectBtn').style.display = 'inline-flex';
            } else {
                document.getElementById('cloudSetup').style.display = 'block';
                document.getElementById('cloudConnected').style.display = 'none';
                document.getElementById('cloudConnectBtn').style.display = 'inline-flex';
                document.getElementById('cloudDisconnectBtn').style.display = 'none';
                // Pre-fill if saved
                if (cloudConfig && cloudConfig.apiKey) {
                    document.getElementById('jsonbinApiKey').value = cloudConfig.apiKey;
                    document.getElementById('jsonbinBinId').value = cloudConfig.binId || '';
                }
            }
            modal.classList.add('show');
        }

        function closeCloudModal() {
            document.getElementById('cloudModal').classList.remove('show');
        }

        async function connectCloud() {
            var apiKey = document.getElementById('jsonbinApiKey').value.trim();
            var binId = document.getElementById('jsonbinBinId').value.trim();

            if (!apiKey) {
                showAlert('Veuillez entrer votre cle API JSONBin.io', 'Cle requise', 'warning');
                return;
            }

            try {
                if (binId) {
                    // Charger le bin existant
                    var response = await fetch('https://api.jsonbin.io/v3/b/' + binId + '/latest', {
                        headers: { 'X-Master-Key': apiKey }
                    });
                    if (!response.ok) throw new Error('Bin non trouve ou cle invalide');

                    var result = await response.json();
                    // Sauvegarder les donnees du cloud dans localStorage
                    if (result.record && result.record.profiles) {
                        localStorage.setItem('gemef-profiles', JSON.stringify(result.record.profiles));
                        // Sauvegarder aussi les donnees de chaque profil
                        if (result.record.profilesData) {
                            Object.keys(result.record.profilesData).forEach(function(key) {
                                localStorage.setItem(key, JSON.stringify(result.record.profilesData[key]));
                            });
                        }
                    }
                } else {
                    // Creer un nouveau bin
                    var initialData = {
                        profiles: JSON.parse(localStorage.getItem('gemef-profiles') || '[]'),
                        profilesData: {},
                        created: new Date().toISOString()
                    };

                    // Recuperer toutes les donnees de profils existantes
                    var profiles = JSON.parse(localStorage.getItem('gemef-profiles') || '[]');
                    profiles.forEach(function(p) {
                        var data = localStorage.getItem('gemef-formation-' + p.id);
                        if (data) initialData.profilesData['gemef-formation-' + p.id] = JSON.parse(data);
                    });

                    var response = await fetch('https://api.jsonbin.io/v3/b', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'X-Master-Key': apiKey,
                            'X-Bin-Name': 'gemef-formation'
                        },
                        body: JSON.stringify(initialData)
                    });
                    if (!response.ok) throw new Error('Erreur creation bin');

                    var result = await response.json();
                    binId = result.metadata.id;
                }

                // Sauvegarder la config
                cloudConfig = { apiKey: apiKey, binId: binId };
                localStorage.setItem('gemef-cloud-config', JSON.stringify(cloudConfig));

                document.getElementById('cloudStatus').textContent = '‚óè Cloud';
                document.getElementById('cloudStatus').style.color = '#90EE90';

                closeCloudModal();
                showAlert('Connecte au cloud ! Bin ID: ' + binId, 'Connexion reussie', 'success');
                location.reload();
            } catch (err) {
                console.error('Erreur connexion cloud:', err);
                showAlert(err.message, 'Erreur de connexion', 'error');
            }
        }

        function disconnectCloud() {
            cloudConfig = null;
            localStorage.removeItem('gemef-cloud-config');
            document.getElementById('cloudStatus').textContent = '';
            closeCloudModal();
            showAlert('Deconnecte du cloud. Les donnees locales sont conservees.', 'Deconnexion', 'success');
        }

        async function loadFromCloud() {
            if (!cloudConfig || !cloudConfig.apiKey || !cloudConfig.binId) return;

            try {
                var response = await fetch('https://api.jsonbin.io/v3/b/' + cloudConfig.binId + '/latest', {
                    headers: { 'X-Master-Key': cloudConfig.apiKey }
                });
                if (!response.ok) return;

                var result = await response.json();
                if (result.record) {
                    if (result.record.profiles) {
                        localStorage.setItem('gemef-profiles', JSON.stringify(result.record.profiles));
                    }
                    if (result.record.profilesData) {
                        Object.keys(result.record.profilesData).forEach(function(key) {
                            localStorage.setItem(key, JSON.stringify(result.record.profilesData[key]));
                        });
                    }
                }
            } catch (err) {
                console.error('Erreur chargement cloud:', err);
            }
        }

        async function saveToCloud() {
            if (!cloudConfig || !cloudConfig.apiKey || !cloudConfig.binId) return;

            try {
                var profiles = JSON.parse(localStorage.getItem('gemef-profiles') || '[]');
                var profilesData = {};

                profiles.forEach(function(p) {
                    var data = localStorage.getItem('gemef-formation-' + p.id);
                    if (data) profilesData['gemef-formation-' + p.id] = JSON.parse(data);
                });

                var cloudData = {
                    profiles: profiles,
                    profilesData: profilesData,
                    lastUpdated: new Date().toISOString()
                };

                await fetch('https://api.jsonbin.io/v3/b/' + cloudConfig.binId, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-Master-Key': cloudConfig.apiKey
                    },
                    body: JSON.stringify(cloudData)
                });
                console.log('Sauvegarde cloud OK');
            } catch (err) {
                console.error('Erreur sauvegarde cloud:', err);
            }
        }

        // ===== SIGNATURE CANVAS =====
        function initSignatureCanvases() {
            var canvasIds = ['signatureTuteur', 'signatureEleve', 'signatureChef'];
            canvasIds.forEach(function(id) {
                var canvas = document.getElementById(id);
                var ctx = canvas.getContext('2d');

                // Set canvas size
                var rect = canvas.getBoundingClientRect();
                canvas.width = rect.width;
                canvas.height = rect.height;

                signatureCanvases[id] = {
                    canvas: canvas,
                    ctx: ctx,
                    drawing: false,
                    lastX: 0,
                    lastY: 0
                };

                // Load saved signature if exists
                if (!currentProfile) return;
                var saved = localStorage.getItem(getProfileKey(currentProfile));
                if (saved) {
                    var data = JSON.parse(saved);
                    if (data.signatures && data.signatures[id]) {
                        var img = new Image();
                        img.onload = function() {
                            ctx.drawImage(img, 0, 0);
                        };
                        img.src = data.signatures[id];
                    }
                }

                // Mouse events
                canvas.addEventListener('mousedown', function(e) { startDrawing(id, e); });
                canvas.addEventListener('mousemove', function(e) { draw(id, e); });
                canvas.addEventListener('mouseup', function() { stopDrawing(id); });
                canvas.addEventListener('mouseout', function() { stopDrawing(id); });

                // Touch events
                canvas.addEventListener('touchstart', function(e) {
                    e.preventDefault();
                    var touch = e.touches[0];
                    startDrawing(id, touch);
                });
                canvas.addEventListener('touchmove', function(e) {
                    e.preventDefault();
                    var touch = e.touches[0];
                    draw(id, touch);
                });
                canvas.addEventListener('touchend', function() { stopDrawing(id); });
            });
        }

        function getCanvasCoords(id, e) {
            var canvas = signatureCanvases[id].canvas;
            var rect = canvas.getBoundingClientRect();
            return {
                x: (e.clientX - rect.left) * (canvas.width / rect.width),
                y: (e.clientY - rect.top) * (canvas.height / rect.height)
            };
        }

        function startDrawing(id, e) {
            var sig = signatureCanvases[id];
            sig.drawing = true;
            var coords = getCanvasCoords(id, e);
            sig.lastX = coords.x;
            sig.lastY = coords.y;
        }

        function draw(id, e) {
            var sig = signatureCanvases[id];
            if (!sig.drawing) return;

            var coords = getCanvasCoords(id, e);
            sig.ctx.beginPath();
            sig.ctx.moveTo(sig.lastX, sig.lastY);
            sig.ctx.lineTo(coords.x, coords.y);
            sig.ctx.strokeStyle = '#2C2C2C';
            sig.ctx.lineWidth = 2;
            sig.ctx.lineCap = 'round';
            sig.ctx.stroke();

            sig.lastX = coords.x;
            sig.lastY = coords.y;
        }

        function stopDrawing(id) {
            var sig = signatureCanvases[id];
            if (sig.drawing) {
                sig.drawing = false;
                saveData();
            }
        }

        function clearSignature(id) {
            var sig = signatureCanvases[id];
            sig.ctx.clearRect(0, 0, sig.canvas.width, sig.canvas.height);
            saveData();
            showNotification('Signature effacee');
        }

        // ===== LOGO UPLOAD =====
        function handleLogoUpload(event) {
            var file = event.target.files[0];
            if (file && file.type.startsWith('image/')) {
                var reader = new FileReader();
                reader.onload = function(e) {
                    customLogo = e.target.result;
                    document.getElementById('logoText').style.display = 'none';
                    var logoImg = document.getElementById('logoImage');
                    logoImg.src = customLogo;
                    logoImg.style.display = 'block';
                    saveData();
                    showNotification('Logo mis a jour');
                };
                reader.readAsDataURL(file);
            }
        }

        // ===== FILTERS =====
        function setFilter(filter) {
            currentFilter = filter;

            // Update filter buttons
            document.querySelectorAll('.filter-btn').forEach(function(btn) {
                btn.classList.remove('active');
            });
            event.target.classList.add('active');

            // Apply filter
            applyFilter();
        }

        function applyFilter() {
            formationData.sections.forEach(function(section) {
                var sectionEl = document.getElementById('section-' + section.id);
                var tasks = sectionEl.querySelectorAll('.task');
                var visibleTasks = 0;

                tasks.forEach(function(taskEl, index) {
                    var status = getTaskStatus(section.id, index);
                    var matches = currentFilter === 'all' ||
                                  status === currentFilter ||
                                  (currentFilter === 'acquired' && status.startsWith('acquired'));
                    if (matches) {
                        taskEl.classList.remove('hidden');
                        visibleTasks++;
                    } else {
                        taskEl.classList.add('hidden');
                    }
                });

                // Hide section if no visible tasks
                if (visibleTasks === 0 && currentFilter !== 'all') {
                    sectionEl.classList.add('hidden');
                } else {
                    sectionEl.classList.remove('hidden');
                }
            });
        }

        // ===== EXPORT/IMPORT =====
        function showExportModal() {
            document.getElementById('exportModal').classList.add('show');
        }

        function closeExportModal() {
            document.getElementById('exportModal').classList.remove('show');
        }

        function exportJSON() {
            var signatures = {};
            ['signatureTuteur', 'signatureEleve', 'signatureChef'].forEach(function(id) {
                var canvas = document.getElementById(id);
                signatures[id] = canvas.toDataURL();
            });

            var data = {
                exportDate: new Date().toISOString(),
                version: '2.0',
                taskStatus: taskStatus,
                taskHistory: taskHistory,
                customLogo: customLogo,
                signatures: signatures,
                formInfo: {
                    tuteurNom: document.getElementById('tuteurNom').value,
                    tuteurPrenom: document.getElementById('tuteurPrenom').value,
                    eleveNom: document.getElementById('eleveNom').value,
                    elevePrenom: document.getElementById('elevePrenom').value,
                    dateDebut: document.getElementById('dateDebut').value,
                    dateFin: document.getElementById('dateFin').value,
                    duree: document.getElementById('duree').value,
                    comments: document.getElementById('comments').value,
                    signatureTuteurDate: document.getElementById('signatureTuteurDate').value,
                    signatureEleveDate: document.getElementById('signatureEleveDate').value,
                    signatureChefDate: document.getElementById('signatureChefDate').value
                }
            };

            var blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
            var url = URL.createObjectURL(blob);
            var a = document.createElement('a');
            a.href = url;
            var filename = 'formation-extrusion';
            if (data.formInfo.eleveNom) {
                filename += '-' + data.formInfo.eleveNom.toLowerCase().replace(/\s+/g, '-');
            }
            filename += '-' + new Date().toISOString().split('T')[0] + '.json';
            a.download = filename;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);

            closeExportModal();
            showNotification('Donnees exportees');
        }

        function importData(event) {
            var file = event.target.files[0];
            if (!file) return;

            var reader = new FileReader();
            reader.onload = function(e) {
                try {
                    var data = JSON.parse(e.target.result);

                    // Restore task status and history
                    taskStatus = data.taskStatus || {};
                    taskHistory = data.taskHistory || {};

                    // Restore custom logo
                    if (data.customLogo) {
                        customLogo = data.customLogo;
                        document.getElementById('logoText').style.display = 'none';
                        var logoImg = document.getElementById('logoImage');
                        logoImg.src = customLogo;
                        logoImg.style.display = 'block';
                    }

                    // Restore form info
                    if (data.formInfo) {
                        document.getElementById('tuteurNom').value = data.formInfo.tuteurNom || '';
                        document.getElementById('tuteurPrenom').value = data.formInfo.tuteurPrenom || '';
                        document.getElementById('eleveNom').value = data.formInfo.eleveNom || '';
                        document.getElementById('elevePrenom').value = data.formInfo.elevePrenom || '';
                        document.getElementById('dateDebut').value = data.formInfo.dateDebut || '';
                        document.getElementById('dateFin').value = data.formInfo.dateFin || '';
                        document.getElementById('duree').value = data.formInfo.duree || '';
                        document.getElementById('comments').value = data.formInfo.comments || '';
                        document.getElementById('signatureTuteurDate').value = data.formInfo.signatureTuteurDate || '';
                        document.getElementById('signatureEleveDate').value = data.formInfo.signatureEleveDate || '';
                        document.getElementById('signatureChefDate').value = data.formInfo.signatureChefDate || '';
                    }

                    // Restore signatures
                    if (data.signatures) {
                        ['signatureTuteur', 'signatureEleve', 'signatureChef'].forEach(function(id) {
                            if (data.signatures[id]) {
                                var canvas = document.getElementById(id);
                                var ctx = canvas.getContext('2d');
                                var img = new Image();
                                img.onload = function() {
                                    ctx.clearRect(0, 0, canvas.width, canvas.height);
                                    ctx.drawImage(img, 0, 0);
                                };
                                img.src = data.signatures[id];
                            }
                        });
                    }

                    renderSections();
                    updateProgress();
                    saveData();
                    showNotification('Donnees importees avec succes');
                } catch (err) {
                    showAlert('Verifiez que c\'est un fichier JSON valide.', 'Erreur d\'import', 'error');
                }
            };
            reader.readAsText(file);
            event.target.value = '';
        }

        // ===== RENDER SECTIONS =====
        function renderSections() {
            var container = document.getElementById('sectionsContainer');
            container.innerHTML = '';
            formationData.sections.forEach(function(section) {
                var sectionEl = document.createElement('div');
                sectionEl.className = 'section';
                sectionEl.id = 'section-' + section.id;
                var sectionProgress = calculateSectionProgress(section.id);
                sectionEl.innerHTML =
                    '<div class="section-header" onclick="toggleSection(' + section.id + ')">' +
                        '<div class="section-title"><span class="section-number">' + section.id + '</span>' + section.title + '</div>' +
                        '<div class="section-progress">' +
                            '<div class="section-progress-bar"><div class="section-progress-fill" id="progress-fill-' + section.id + '" style="width: ' + sectionProgress + '%"></div></div>' +
                            '<span class="section-progress-text" id="progress-text-' + section.id + '">' + sectionProgress + '%</span>' +
                            '<span class="toggle-icon">&#9660;</span>' +
                        '</div>' +
                    '</div>' +
                    '<div class="section-content">' +
                        section.tasks.map(function(task, index) {
                            var history = getTaskHistory(section.id, index);
                            var historyHtml = history ? '<div class="task-history">Modifie le ' + history + '</div>' : '';
                            return '<div class="task">' +
                                '<div class="task-main">' +
                                    '<div class="task-text">' + task + '</div>' +
                                    '<div class="task-status">' +
                                        '<button class="status-btn pending ' + (getTaskStatus(section.id, index) === 'pending' ? 'active' : '') + '" onclick="setStatus(' + section.id + ', ' + index + ', \'pending\')">A acquerir</button>' +
                                        '<button class="status-btn progress ' + (getTaskStatus(section.id, index) === 'progress' ? 'active' : '') + '" onclick="setStatus(' + section.id + ', ' + index + ', \'progress\')">En cours</button>' +
                                        '<select class="acquis-select ' + (getTaskStatus(section.id, index).startsWith('acquired') ? 'active' : '') + '" onchange="setAcquisLevel(' + section.id + ', ' + index + ', this.value)">' +
                                            '<option value="">Acquis</option>' +
                                            '<option value="acquired-1" ' + (getTaskStatus(section.id, index) === 'acquired-1' ? 'selected' : '') + '>Acquis 1/5</option>' +
                                            '<option value="acquired-2" ' + (getTaskStatus(section.id, index) === 'acquired-2' ? 'selected' : '') + '>Acquis 2/5</option>' +
                                            '<option value="acquired-3" ' + (getTaskStatus(section.id, index) === 'acquired-3' ? 'selected' : '') + '>Acquis 3/5</option>' +
                                            '<option value="acquired-4" ' + (getTaskStatus(section.id, index) === 'acquired-4' ? 'selected' : '') + '>Acquis 4/5</option>' +
                                            '<option value="acquired-5" ' + (getTaskStatus(section.id, index) === 'acquired-5' ? 'selected' : '') + '>Acquis 5/5</option>' +
                                        '</select>' +
                                    '</div>' +
                                '</div>' +
                                historyHtml +
                            '</div>';
                        }).join('') +
                    '</div>';
                container.appendChild(sectionEl);
            });
            applyFilter();
        }

        function toggleSection(sectionId) { document.getElementById('section-' + sectionId).classList.toggle('collapsed'); }
        function expandAll() { document.querySelectorAll('.section').forEach(function(s) { s.classList.remove('collapsed'); }); }
        function getTaskStatus(sectionId, taskIndex) { return taskStatus[sectionId + '-' + taskIndex] || 'pending'; }
        function getTaskHistory(sectionId, taskIndex) { return taskHistory[sectionId + '-' + taskIndex] || ''; }

        function setStatus(sectionId, taskIndex, status) {
            var key = sectionId + '-' + taskIndex;
            var oldStatus = taskStatus[key] || 'pending';

            if (oldStatus !== status) {
                taskStatus[key] = status;
                taskHistory[key] = new Date().toLocaleDateString('fr-FR') + ' a ' + new Date().toLocaleTimeString('fr-FR', {hour: '2-digit', minute: '2-digit'});

                var section = document.getElementById('section-' + sectionId);
                var taskEl = section.querySelectorAll('.task')[taskIndex];
                taskEl.querySelectorAll('.status-btn').forEach(function(btn) {
                    btn.classList.remove('active');
                    if (btn.classList.contains(status)) btn.classList.add('active');
                });

                // Reset acquis select si on clique sur pending ou progress
                var acquisSelect = taskEl.querySelector('.acquis-select');
                if (acquisSelect) {
                    acquisSelect.value = '';
                    acquisSelect.classList.remove('active');
                }

                // Update history display
                var historyEl = taskEl.querySelector('.task-history');
                if (historyEl) {
                    historyEl.textContent = 'Modifie le ' + taskHistory[key];
                } else {
                    var historyDiv = document.createElement('div');
                    historyDiv.className = 'task-history';
                    historyDiv.textContent = 'Modifie le ' + taskHistory[key];
                    taskEl.appendChild(historyDiv);
                }

                updateProgress();
                saveData();
                applyFilter();
            }
        }

        function setAcquisLevel(sectionId, taskIndex, level) {
            if (!level) return; // Si on selectionne l'option vide

            var key = sectionId + '-' + taskIndex;
            taskStatus[key] = level;
            taskHistory[key] = new Date().toLocaleDateString('fr-FR') + ' a ' + new Date().toLocaleTimeString('fr-FR', {hour: '2-digit', minute: '2-digit'});

            var section = document.getElementById('section-' + sectionId);
            var taskEl = section.querySelectorAll('.task')[taskIndex];

            // Desactiver les boutons pending/progress
            taskEl.querySelectorAll('.status-btn').forEach(function(btn) {
                btn.classList.remove('active');
            });

            // Activer le select
            var acquisSelect = taskEl.querySelector('.acquis-select');
            if (acquisSelect) {
                acquisSelect.classList.add('active');
            }

            // Update history display
            var historyEl = taskEl.querySelector('.task-history');
            if (historyEl) {
                historyEl.textContent = 'Modifie le ' + taskHistory[key];
            } else {
                var historyDiv = document.createElement('div');
                historyDiv.className = 'task-history';
                historyDiv.textContent = 'Modifie le ' + taskHistory[key];
                taskEl.appendChild(historyDiv);
            }

            updateProgress();
            saveData();
            applyFilter();
        }

        function calculateSectionProgress(sectionId) {
            var section = formationData.sections.find(function(s) { return s.id === sectionId; });
            if (!section) return 0;
            var acquired = 0;
            section.tasks.forEach(function(_, index) {
                var status = getTaskStatus(sectionId, index);
                if (status.startsWith('acquired')) acquired++;
            });
            return Math.round((acquired / section.tasks.length) * 100);
        }

        function updateProgress() {
            var totalTasks = 0, pendingCount = 0, progressCount = 0, acquiredCount = 0;
            formationData.sections.forEach(function(section) {
                section.tasks.forEach(function(_, index) {
                    totalTasks++;
                    var status = getTaskStatus(section.id, index);
                    if (status === 'pending') pendingCount++;
                    else if (status === 'progress') progressCount++;
                    else if (status.startsWith('acquired')) acquiredCount++;
                });
                var sectionProgress = calculateSectionProgress(section.id);
                var fillEl = document.getElementById('progress-fill-' + section.id);
                var textEl = document.getElementById('progress-text-' + section.id);
                if (fillEl) fillEl.style.width = sectionProgress + '%';
                if (textEl) textEl.textContent = sectionProgress + '%';
            });
            var globalProgress = Math.round((acquiredCount / totalTasks) * 100);
            document.getElementById('globalPercentage').textContent = globalProgress + '%';
            document.getElementById('globalProgressBar').style.width = globalProgress + '%';
            document.getElementById('pendingCount').textContent = pendingCount;
            document.getElementById('progressCount').textContent = progressCount;
            document.getElementById('acquiredCount').textContent = acquiredCount;
        }

        function saveData() {
            var signatures = {};
            ['signatureTuteur', 'signatureEleve', 'signatureChef'].forEach(function(id) {
                var canvas = document.getElementById(id);
                if (canvas) {
                    signatures[id] = canvas.toDataURL();
                }
            });

            var data = {
                taskStatus: taskStatus,
                taskHistory: taskHistory,
                customLogo: customLogo,
                signatures: signatures,
                formInfo: {
                    tuteurNom: document.getElementById('tuteurNom').value,
                    tuteurPrenom: document.getElementById('tuteurPrenom').value,
                    eleveNom: document.getElementById('eleveNom').value,
                    elevePrenom: document.getElementById('elevePrenom').value,
                    dateDebut: document.getElementById('dateDebut').value,
                    dateFin: document.getElementById('dateFin').value,
                    duree: document.getElementById('duree').value,
                    comments: document.getElementById('comments').value,
                    signatureTuteurDate: document.getElementById('signatureTuteurDate').value,
                    signatureEleveDate: document.getElementById('signatureEleveDate').value,
                    signatureChefDate: document.getElementById('signatureChefDate').value
                }
            };
            if (currentProfile) {
                localStorage.setItem(getProfileKey(currentProfile), JSON.stringify(data));
                updateProfileProgress();
                // Sauvegarder aussi dans le cloud si connecte
                if (cloudConfig) {
                    saveToCloud();
                }
            }
        }

        function loadData() {
            if (!currentProfile) return;
            var saved = localStorage.getItem(getProfileKey(currentProfile));
            if (saved) {
                var data = JSON.parse(saved);
                taskStatus = data.taskStatus || {};
                taskHistory = data.taskHistory || {};
                customLogo = data.customLogo || null;

                // Load custom logo (si un logo personnalise a ete importe)
                if (customLogo) {
                    var logoImg = document.getElementById('logoImage');
                    if (logoImg) {
                        logoImg.src = customLogo;
                    }
                }

                if (data.formInfo) {
                    document.getElementById('tuteurNom').value = data.formInfo.tuteurNom || '';
                    document.getElementById('tuteurPrenom').value = data.formInfo.tuteurPrenom || '';
                    document.getElementById('eleveNom').value = data.formInfo.eleveNom || '';
                    document.getElementById('elevePrenom').value = data.formInfo.elevePrenom || '';
                    document.getElementById('dateDebut').value = data.formInfo.dateDebut || '';
                    document.getElementById('dateFin').value = data.formInfo.dateFin || '';
                    document.getElementById('duree').value = data.formInfo.duree || '';
                    document.getElementById('comments').value = data.formInfo.comments || '';
                    document.getElementById('signatureTuteurDate').value = data.formInfo.signatureTuteurDate || '';
                    document.getElementById('signatureEleveDate').value = data.formInfo.signatureEleveDate || '';
                    document.getElementById('signatureChefDate').value = data.formInfo.signatureChefDate || '';
                }
            }
        }

        function setupAutoSave() {
            document.querySelectorAll('input, textarea').forEach(function(input) {
                input.addEventListener('change', function() { saveData(); });
            });
        }

        function showNotification(message) {
            var notif = document.getElementById('notification');
            notif.innerHTML = '&#10003; ' + (message || 'Donnees sauvegardees');
            notif.classList.add('show');
            setTimeout(function() { notif.classList.remove('show'); }, 2000);
        }

        // ===== MODAL ALERT =====
        function showAlert(message, title, type) {
            var header = document.getElementById('alertModalHeader');
            var titleEl = document.getElementById('alertModalTitle');
            var messageEl = document.getElementById('alertModalMessage');

            titleEl.textContent = title || 'Information';
            messageEl.textContent = message;

            // Style selon le type
            if (type === 'error') {
                header.style.background = 'linear-gradient(135deg, #E74C3C 0%, #C0392B 100%)';
            } else if (type === 'warning') {
                header.style.background = 'linear-gradient(135deg, #F39C12 0%, #E67E22 100%)';
            } else if (type === 'success') {
                header.style.background = 'linear-gradient(135deg, #27AE60 0%, #219a52 100%)';
            } else {
                header.style.background = 'linear-gradient(135deg, var(--gemef-orange) 0%, var(--gemef-orange-dark) 100%)';
            }

            document.getElementById('alertModal').classList.add('show');
        }

        function closeAlertModal() {
            document.getElementById('alertModal').classList.remove('show');
        }

        function resetData() {
            if (!currentProfile) {
                showAlert('Veuillez d\'abord selectionner un profil', 'Aucun profil', 'warning');
                return;
            }
            var profiles = JSON.parse(localStorage.getItem('gemef-profiles') || '[]');
            var profile = profiles.find(function(p) { return p.id === currentProfile; });
            document.getElementById('resetProfileName').textContent = profile.name;
            document.getElementById('resetModal').classList.add('show');
        }

        function closeResetModal() {
            document.getElementById('resetModal').classList.remove('show');
        }

        function confirmResetProfile() {
            var profiles = JSON.parse(localStorage.getItem('gemef-profiles') || '[]');
            var profile = profiles.find(function(p) { return p.id === currentProfile; });
            // Reinitialiser les donnees mais garder le nom
            var initialData = {
                taskStatus: {},
                taskHistory: {},
                formInfo: {
                    eleveNom: profile ? profile.name.split(' ')[0] : '',
                    elevePrenom: profile ? profile.name.split(' ').slice(1).join(' ') : ''
                }
            };
            localStorage.setItem(getProfileKey(currentProfile), JSON.stringify(initialData));
            // Mettre a jour le progress a 0
            profiles = profiles.map(function(p) {
                if (p.id === currentProfile) p.progress = 0;
                return p;
            });
            localStorage.setItem('gemef-profiles', JSON.stringify(profiles));
            closeResetModal();
            location.reload();
        }

        function exportPDF() {
            expandAll();
            currentFilter = 'all';
            applyFilter();
            setTimeout(function() { window.print(); }, 300);
        }
    </script>
</body>
</html>
